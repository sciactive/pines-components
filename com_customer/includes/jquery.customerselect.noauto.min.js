/*
 * jQuery Customer Select Without Autocomplete (customerselect_noauto) Plugin 1.0.0
 *
 * Copyright (c) 2014 Angela Murrell, Grey Vugrin, Mohammed Ahmed
 *
 * Licensed (along with all of Pines) under the GNU Affero GPL:
 *	  http://www.gnu.org/licenses/agpl.html
 */

(function(e){e.fn.customerselect=function(t){var n=this;n.each(function(){function p(){o=t.val();e.ajax({url:pines.com_customer_autocustomer_url,dataType:"json",data:{q:t.val()},success:function(n){if(!n){s=[];c.html(f);e("#"+i).click(function(e){l.modal("toggle");t.focus()});return}s=e.map(n,function(e){return{id:pines.safe(e.guid),label:pines.safe(e.name),value:e.guid+": "+e.name,desc:"<em>"+(e.email?" "+pines.safe(e.email):"")+(e.phone_cell?" "+pines.safe(e.phone_cell):e.phone_home?" "+pines.safe(e.phone_home):e.phone_work?" "+pines.safe(e.phone_work):"")+"</em>"}});d()}})}function d(){t.trigger("customer_results_opened");var n=s.length;var r='<ul class="unstyled">';for(var i=0;i<n;i++){r+="<li class='customerselect_results' data-resultid='"+i.toString()+"'><a style='margin-bottom: 10px;' class='btn btn-block'><strong>"+s[i].label+"</strong><br />"+s[i].desc+"</a></li>"}r+="</ul>";c.html(r);e(".customerselect_results").click(function(n){var r=e(this).attr("data-resultid");var i=s[r].value;u=i;t.val(i);l.modal("toggle");t.trigger("customer_selected")})}function v(){if(t.val()=="")return;if(t.val()!=o&&t.val()!=u){c.html(h);p()}l.modal("toggle");t.trigger("customer_modal_opened")}function m(){var e=t.outerHeight();if(!e){setTimeout(function(){m()},200);return}var n='<span class="noauto-wrapper" style="position: relative; font-size: '+e+"px; line-height: "+e+'px; "></span>';var r='<a class="searchbtn" style="top: 0; height: '+e+'px; text-decoration: none; cursor: pointer; z-index: 3; position: absolute; padding: 0 5px; right: 0px;"><i style="font-size: 14px;" class="icon-search"></i></a>';t.wrap(n).after(r);t.next("a").click(function(){v()})}var t=e(this);var n=t[0].id;var r="customermodal";var i="back_to_search";if(n.length){r+="-"+n;i+="-"+n}var s=[];var o="";var u="";var a='<div id="'+r+'" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="customerselect" aria-hidden="false"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button><h3 id="myModalLabel">Pick A Customer:</h3></div><div id="#customerselect-body" class="modal-body" style="min-height: 130px;"><div style="text-align: center; margin-top: 30px;" id="throbber"><i style="font-size: 30px; margin-bottom: 10px;" class="icon-spinner icon-spin icon-large"> </i><br />Loading...</div></div></div>';var f='<div class="alert alert-info"><h4>No Result Found</h4><p>The person may not exist, or your term is misspelled.</p><a id="'+i+'" class="btn btn-info">Back to Search</a></div>';e("body").append(a);var l=e("#"+r);var c=e("#"+r+" .modal-body");var h=e("#"+r+" #throbber");m();t.keypress(function(e){if(e.which==13){v();e.preventDefault()}});t.on("customer_search",function(){v()});t.on("remove_search_icon",function(){t.next("a").remove()});t.on("add_search_icon",function(){m()})});return n}})(jQuery);