/*
 * jQuery Customer Select Without Autocomplete (customerselect_noauto) Plugin 1.0.0
 *
 * Copyright (c) 2014 Angela Murrell, Grey Vugrin, Mohammed Ahmed
 *
 * Licensed (along with all of Pines) under the GNU Affero GPL:
 *	  http://www.gnu.org/licenses/agpl.html
 */

(function(e){e.fn.customerselect=function(t){var n=this;n.each(function(){function l(){r=t.val();e.ajax({url:pines.com_customer_autocustomer_url,dataType:"json",data:{q:t.val()},success:function(r){if(!r){n=[];a.html(o);e("#back_to_search").click(function(e){u.modal("toggle");t.focus()});return}n=e.map(r,function(e){return{id:pines.safe(e.guid),label:pines.safe(e.name),value:e.guid+": "+e.name,desc:"<em>"+(e.email?" "+pines.safe(e.email):"")+(e.phone_cell?" "+pines.safe(e.phone_cell):e.phone_home?" "+pines.safe(e.phone_home):e.phone_work?" "+pines.safe(e.phone_work):"")+"</em>"}});c()}})}function c(){t.trigger("customer_results_opened");var r=n.length;var s='<ul class="unstyled">';for(var o=0;o<r;o++){s+="<li class='customerselect_results' data-resultid='"+o.toString()+"'><a style='margin-bottom: 10px;' class='btn btn-block'><strong>"+n[o].label+"</strong><br />"+n[o].desc+"</a></li>"}s+="</ul>";a.html(s);e(".customerselect_results").click(function(r){var s=e(this).attr("data-resultid");var o=n[s].value;i=o;t.val(o);u.modal("toggle");t.trigger("customer_selected")})}function h(){if(t.val()=="")return;if(t.val()!=r&&t.val()!=i){a.html(f);l()}u.modal("toggle");t.trigger("customer_modal_opened")}function p(){var e=t.outerHeight();if(!e){setTimeout(function(){p()},200);return}var n='<span class="noauto-wrapper" style="position: relative; font-size: '+e+"px; line-height: "+e+'px; "></span>';var r='<a class="searchbtn" style="top: 0; height: '+e+'px; text-decoration: none; cursor: pointer; z-index: 3; position: absolute; padding: 0 5px; right: 0px;"><i style="font-size: 14px;" class="icon-search"></i></a>';t.wrap(n).after(r);t.next("a").click(function(){h()})}var t=e(this);var n=[];var r="";var i="";var s='<div style="display: block;" id="customermodal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="customerselect" aria-hidden="false"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button><h3 id="myModalLabel">Pick A Customer:</h3></div><div id="#customerselect-body" class="modal-body" style="min-height: 130px;"><div style="text-align: center; margin-top: 30px;" id="throbber"><i style="font-size: 30px; margin-bottom: 10px;" class="icon-spinner icon-spin icon-large"> </i><br />Loading...</div></div></div>';var o='<div class="alert alert-info"><h4>No Result Found</h4><p>The person may not exist, or your term is misspelled.</p><a id="back_to_search" class="btn btn-info">Back to Search</a></div>';e("body").append(s);var u=e("#customermodal");var a=e("#customermodal .modal-body");var f=e("#customermodal #throbber");p();t.keypress(function(e){if(e.which==13){h();e.preventDefault()}});t.on("customer_search",function(){h()});t.on("remove_search_icon",function(){t.next("a").remove()});t.on("add_search_icon",function(){p()})});return n}})(jQuery);