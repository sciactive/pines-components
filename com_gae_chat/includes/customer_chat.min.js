pines(function(){function a(e,t){channel_id=e;channel_token=t;v()}function f(e){var t=new Date;var n=t.getTimezoneOffset()*60*1e3;var r=new Date(e-n);return r.toISOString()}function l(e,t,n,r){chatHistory[e]={from_channel:t,message:n,username:r}}function c(){connectedToChannel=true;o.removeClass("offline checking");u.html("Online")}function h(e){var t=jQuery.parseJSON(e.data);if(t!==undefined){if(t.type=="customer_message"){l(t.message_id,t.from_channel,t.message,t.username);w(t.message,t.username,f(t.timestamp),false)}else if(t.type=="employee_message"){l(t.message_id,t.from_channel,t.message,t.username);w(t.message,t.username,f(t.timestamp),true)}else if(t.type=="chat_history"){b(t)}else if(t.type=="online_check"){m()}else{i.append("<li><p>"+t.message+"</p></li>")}}else{}}function p(e){if(e.code=="401"){channel_errors=true}}function d(){connectedToChannel=false;o.addClass("Offline");u.html("Offline");if(channel_errors&&channel_retries<5){channel_retries++;y()}}function v(){channel=new goog.appengine.Channel(channel_token);socket=channel.open();socket.onopen=c;socket.onmessage=h;socket.onerror=p;socket.onclose=d}function m(){var e="//chat-dot-webapp108.appspot.com/chat/testonline";var t={channel_id:channel_id,channel_token:channel_token};if($.browser.msie&&window.XDomainRequest){var n=new XDomainRequest;n.onload=function(){};n.onerror=function(){};n.ontimeout=function(){};n.onprogress=function(){};n.timeout=8e3;n.open("POST",onlineTestURL);n.send($.param(t))}else{$.ajax({type:"POST",url:onlineTestURL,data:t,crossDomain:true,dataType:"json",success:function(){},error:function(){}})}}function g(e){if(connectedToChannel){var t=new Date;var n=t.getTime();var s=t.getTimezoneOffset()*60*1e3;var o=new Date(n+s);var u={channel_id:channel_id,msg:e,timestamp:o.getTime(),channel_token:channel_token};if($.browser.msie&&window.XDomainRequest){var a=new XDomainRequest;a.onload=function(){var t=JSON.parse(a.responseText);if(t.status=="success"){w(e,t.username,f(o.getTime()),false);l(t.message_id,channel_id,e,t.username)}};a.onerror=function(){i.append("<li><p>There was an error sending the message. Please try again</p></li>");r.scrollTop(i.height())};a.ontimeout=function(){i.append("<li><p>There was a timeout error. It took too long to send the message. Please try again</p></li>");r.scrollTop(i.height())};a.onprogress=function(){};a.timeout=8e3;a.open("POST",sendMessageURL);a.send($.param(u))}else{$.ajax({type:"POST",url:sendMessageURL,data:u,crossDomain:true,dataType:"json",success:function(t){if(t.status=="success"){w(e,t.username,f(o.getTime()),false)}},error:function(){i.append("<li><p>There was an error sending the message. Please try again</p></li>");r.scrollTop(i.height())}})}}else{i.append("<li><p>Need to be connected to Chat to send messages</p></li>");r.scrollTop(i.height())}}function y(){o.removeClass("offline").addClass("checking");u.html("Connecting");$.ajax({type:"POST",url:getTokenURL,data:{},dataType:"json",success:function(e){a(e.channel_id,e.channel_token)},error:function(){i.append("<li><p>There was an error connecting to chat. Please refresh your page.</p></li>");r.scrollTop(i.height())}})}function b(e){var t=e.messages.length;for(var n=0;n<t;n++){var r=e.messages[n];if(!chatHistory[r.message_id]){w(r.message,r.from_username,f(r.timestamp),channel_id!=r.from_channel);l(r.message_id,r.from_channel,r.message,r.from_username)}}}function w(e,s,o,u){if(u){var a='<li class="left clearfix chat-message"><span class="chat-img pull-left"><img src="'+n+'" alt="User Avatar" class="img-circle"/></span>'+'<div class="chat-message-left"><div class="header"><strong class="primary-font chat-username">'+s+"</strong> "+'<small class="pull-right text-muted">'+'<i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+o+'">'+o+"</abbr></small></div>"+"<p>"+e+"</p></div></li>"}else{var a='<li class="right clearfix chat-message"><span class="chat-img pull-right"><img src="'+t+'" alt="User Avatar" class="img-circle"/></span>'+'<div class="chat-message-right"><div class="header">'+'<small class="text-muted">'+'<i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+o+'">'+o+"</abbr></small>"+'<strong class="pull-right primary-font">You</strong>'+"</div><p>"+e+"</p></div></li>"}i.append(a);r.scrollTop(i.height());$("abbr.timeago").timeago()}var e=$("#gae-chat-variables");if(!e.length){return}connectedToChannel=false;chatHistory={};channel_errors=false;channel_retries=0;sendMessageURL=$("#send_message_url").attr("data-url");getTokenURL=$("#get_token_url").attr("data-url");onlineTestURL=$("#online_test_url").attr("data-url");onlineCheckURL=$("#send_online_check_url").attr("data-url");var t=$("#chat_customer_pic").attr("data-url");var n=$("#chat_employee_pic").attr("data-url");var r=$("#main-chat-body");var i=$("#main-chat-messages");var s=$("#main-chat-header");var o=s.find(".chat-status");var u=s.find(".chat-status-text");if(!Date.prototype.toISOString){(function(){function e(e){if(e<10){return"0"+e}return e}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+e(this.getUTCMonth()+1)+"-"+e(this.getUTCDate())+"T"+e(this.getUTCHours())+":"+e(this.getUTCMinutes())+":"+e(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}})()}$("#chat-send-message-btn").click(function(){var e=$("#chat-btn-input").val();if(e){g(e);$("#chat-btn-input").val("")}});$("#chat-btn-input").on("keyup",function(e){var t=$("#chat-btn-input").val();if(e.which==13&&t){g(t);$("#chat-btn-input").val("")}});s.on("click",function(e){if(e.target!=this){return}if($(this).hasClass("chat-minimized")){r.show();$(this).removeClass("chat-minimized");$("#min-main-chat-btn").html("<i class='icon-chevron-down'></i>")}});$("#min-main-chat-btn").on("click",function(e){if(s.hasClass("chat-minimized")){r.show();s.removeClass("chat-minimized");$(this).html("<i class='icon-chevron-down'></i>")}else{r.hide();s.addClass("chat-minimized");$(this).html("<i class='icon-chevron-up'></i>")}});$.timeago.settings.strings.seconds="seconds";y()});