pines(function(){function e(e,n){channel_id=e,channel_token=n,c()}function n(e){return new Date(Number(e)).toISOString()}function s(e,n,s,a){chatHistory[e]={from_channel:n,message:s,username:a}}function a(){connectedToChannel=!0,k.removeClass("offline checking"),y.html("Online"),d()}function t(e){var a=jQuery.parseJSON(e.data);void 0!==a&&("message"==a.type?g(a.message.message,a.message.from_username,n(a.message.timestamp),!0):"customer_message"==a.type?(s(a.message_id,a.from_channel,a.message,a.username),g(a.message,a.username,n(a.timestamp),!1)):"employee_message"==a.type?(s(a.message_id,a.from_channel,a.message,a.username),g(a.message,a.username,n(a.timestamp),!0)):"online_check"==a.type?r():T.append("<li><p>"+a.message+"</p></li>"))}function i(e){"401"==e.code&&(channel_errors=!0)}function o(){connectedToChannel=!1,k.addClass("offline"),y.html("Offline"),channel_errors&&5>channel_retries&&(channel_retries++,h("true"))}function c(){channel=new goog.appengine.Channel(channel_token),socket=channel.open(),socket.onopen=a,socket.onmessage=t,socket.onerror=i,socket.onclose=o}function r(){var e={channel_id:channel_id,channel_token:channel_token};if($.browser.msie&&window.XDomainRequest){var n=new XDomainRequest;n.onload=function(){},n.onerror=function(){},n.ontimeout=function(){},n.onprogress=function(){},n.timeout=8e3,n.open("POST",onlineTestURL),n.send($.param(e))}else $.ajax({type:"POST",url:onlineTestURL,data:e,crossDomain:!0,dataType:"json",success:function(){},error:function(){}})}function l(e){if(connectedToChannel){var a=(new Date).getTime(),t={channel_id:channel_id,msg:e,timestamp:a,channel_token:channel_token};if($.browser.msie&&window.XDomainRequest){var i=new XDomainRequest;i.onload=function(){var t=JSON.parse(i.responseText);"success"==t.status&&(g(e,t.username,n(a),!1),s(t.message_id,channel_id,e,t.username))},i.onerror=function(){T.append("<li><p>There was an error sending the message. Please try again</p></li>"),v.scrollTop(T.height())},i.ontimeout=function(){T.append("<li><p>There was a timeout error. It took too long to send the message. Please try again</p></li>"),v.scrollTop(T.height())},i.onprogress=function(){},i.timeout=8e3,i.open("POST",sendMessageURL),i.send($.param(t))}else $.ajax({type:"POST",url:sendMessageURL,data:t,crossDomain:!0,dataType:"json",success:function(s){"success"==s.status&&g(e,s.username,n(a),!1)},error:function(){T.append("<li><p>There was an error sending the message. Please try again</p></li>"),v.scrollTop(T.height())}})}else T.append("<li><p>Need to be connected to Chat to send messages</p></li>"),v.scrollTop(T.height())}function m(){$("#main-chat-window").remove(),$("#gae-chat-variables").remove()}function h(n){k.removeClass("offline").addClass("checking"),y.html("Connecting"),$.ajax({type:"POST",url:getTokenURL,data:{force_new_token:n},dataType:"json",success:function(n){"success"!=n.status||"terminate"==n.action?m():($("#main-chat-window").removeClass("hide"),e(n.channel_id,n.channel_token))},error:function(){T.append("<li><p>There was an error connecting to chat. Please refresh your page.</p></li>"),v.scrollTop(T.height())}})}function u(e){for(var a=e.length,t=0;a>t;t++){var i=e[t];chatHistory[i.message_id]||(g(i.message,i.from_username,n(i.timestamp),channel_id!=i.from_channel),s(i.message_id,i.from_channel,i.message,i.from_username))}}function g(e,n,s,a){if(a)var t='<li class="left clearfix chat-message"><span class="chat-img pull-left"><img src="'+_+'" alt="User Avatar" class="img-circle"/></span><div class="chat-message-left"><div class="header"><strong class="primary-font chat-username">'+n+'</strong> <small class="pull-right text-muted"><i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+s+'">'+s+"</abbr></small></div><p>"+e+"</p></div></li>";else var t='<li class="right clearfix chat-message"><span class="chat-img pull-right"><img src="'+f+'" alt="User Avatar" class="img-circle"/></span><div class="chat-message-right"><div class="header"><small class="text-muted"><i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+s+'">'+s+'</abbr></small><strong class="pull-right primary-font">You</strong></div><p>'+e+"</p></div></li>";T.append(t),v.scrollTop(T.height()),$("abbr.timeago").timeago()}function d(){var e={channel_token:channel_token,channel_id:channel_id};if($.browser.msie&&window.XDomainRequest){var n=new XDomainRequest;n.onload=function(e){"success"==e.status&&u(e.messages)},n.onerror=function(){},n.ontimeout=function(){},n.onprogress=function(){},n.timeout=8e3,n.open("GET",getMessagesURL),n.send($.param(e))}else $.ajax({type:"GET",url:getMessagesURL,data:e,crossDomain:!0,dataType:"json",success:function(e){"success"==e.status&&u(e.messages)},error:function(){}})}var p=$("#gae-chat-variables");if(p.length){connectedToChannel=!1,chatHistory={},channel_errors=!1,channel_retries=0,sendMessageURL=$("#send_message_url").attr("data-url"),getTokenURL=$("#get_token_url").attr("data-url"),onlineTestURL=$("#online_test_url").attr("data-url"),onlineCheckURL=$("#send_online_check_url").attr("data-url"),getMessagesURL=$("#get_messages_url").attr("data-url");var f=$("#chat_customer_pic").attr("data-url"),_=$("#chat_employee_pic").attr("data-url"),v=$("#main-chat-body"),T=$("#main-chat-messages"),w=$("#main-chat-header"),k=w.find(".chat-status"),y=w.find(".chat-status-text");Date.prototype.toISOString||!function(){function e(e){return 10>e?"0"+e:e}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+e(this.getUTCMonth()+1)+"-"+e(this.getUTCDate())+"T"+e(this.getUTCHours())+":"+e(this.getUTCMinutes())+":"+e(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}}(),$("#chat-send-message-btn").click(function(){var e=$("#chat-btn-input").val();e&&(l(e),$("#chat-btn-input").val(""))}),$("#chat-btn-input").on("keyup",function(e){var n=$("#chat-btn-input").val();13==e.which&&n&&(l(n),$("#chat-btn-input").val(""))}),w.on("click",function(e){e.target==this&&$(this).hasClass("chat-minimized")&&(v.show(),$(this).removeClass("chat-minimized"),$("#min-main-chat-btn").html("<i class='icon-chevron-down'></i>"))}),$("#min-main-chat-btn").on("click",function(){w.hasClass("chat-minimized")?(v.show(),w.removeClass("chat-minimized"),$(this).html("<i class='icon-chevron-down'></i>")):(v.hide(),w.addClass("chat-minimized"),$(this).html("<i class='icon-chevron-up'></i>"))}),$.timeago.settings.strings.seconds="seconds",h()}});