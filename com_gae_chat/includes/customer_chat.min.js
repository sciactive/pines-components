pines(function(){function a(e,t){channel_id=e;channel_token=t;v()}function f(e){return(new Date(Number(e))).toISOString()}function l(e,t,n,r){chatHistory[e]={from_channel:t,message:n,username:r}}function c(){connectedToChannel=true;o.removeClass("offline checking");u.html("Online")}function h(e){var t=jQuery.parseJSON(e.data);if(t!==undefined){if(t.type=="customer_message"){l(t.message_id,t.from_channel,t.message,t.username);E(t.message,t.username,f(t.timestamp),false)}else if(t.type=="employee_message"){l(t.message_id,t.from_channel,t.message,t.username);E(t.message,t.username,f(t.timestamp),true)}else if(t.type=="chat_history"){w(t);S()}else if(t.type=="online_check"){m()}else{i.append("<li><p>"+t.message+"</p></li>")}}else{}}function p(e){if(e.code=="401"){channel_errors=true}}function d(){connectedToChannel=false;o.addClass("Offline");u.html("Offline");if(channel_errors&&channel_retries<5){channel_retries++;b("true")}}function v(){channel=new goog.appengine.Channel(channel_token);socket=channel.open();socket.onopen=c;socket.onmessage=h;socket.onerror=p;socket.onclose=d}function m(){var e={channel_id:channel_id,channel_token:channel_token};if($.browser.msie&&window.XDomainRequest){var t=new XDomainRequest;t.onload=function(){};t.onerror=function(){};t.ontimeout=function(){};t.onprogress=function(){};t.timeout=8e3;t.open("POST",onlineTestURL);t.send($.param(e))}else{$.ajax({type:"POST",url:onlineTestURL,data:e,crossDomain:true,dataType:"json",success:function(){},error:function(){}})}}function g(e){if(connectedToChannel){var t=(new Date).getTime();var n={channel_id:channel_id,msg:e,timestamp:t,channel_token:channel_token};if($.browser.msie&&window.XDomainRequest){var s=new XDomainRequest;s.onload=function(){var n=JSON.parse(s.responseText);if(n.status=="success"){E(e,n.username,f(t),false);l(n.message_id,channel_id,e,n.username)}};s.onerror=function(){i.append("<li><p>There was an error sending the message. Please try again</p></li>");r.scrollTop(i.height())};s.ontimeout=function(){i.append("<li><p>There was a timeout error. It took too long to send the message. Please try again</p></li>");r.scrollTop(i.height())};s.onprogress=function(){};s.timeout=8e3;s.open("POST",sendMessageURL);s.send($.param(n))}else{$.ajax({type:"POST",url:sendMessageURL,data:n,crossDomain:true,dataType:"json",success:function(n){if(n.status=="success"){E(e,n.username,f(t),false)}},error:function(){i.append("<li><p>There was an error sending the message. Please try again</p></li>");r.scrollTop(i.height())}})}}else{i.append("<li><p>Need to be connected to Chat to send messages</p></li>");r.scrollTop(i.height())}}function y(){$("#main-chat-window").remove();$("#gae-chat-variables").remove()}function b(e){o.removeClass("offline").addClass("checking");u.html("Connecting");$.ajax({type:"POST",url:getTokenURL,data:{force_new_token:e},dataType:"json",success:function(e){if(e.status!="success"||e.action=="terminate"){y()}else{$("#main-chat-window").removeClass("hide");a(e.channel_id,e.channel_token)}},error:function(){i.append("<li><p>There was an error connecting to chat. Please refresh your page.</p></li>");r.scrollTop(i.height())}})}function w(e){var t=e.messages.length;for(var n=0;n<t;n++){var r=e.messages[n];if(!chatHistory[r.message_id]){E(r.message,r.from_username,f(r.timestamp),channel_id!=r.from_channel);l(r.message_id,r.from_channel,r.message,r.from_username)}}}function E(e,s,o,u){if(u){var a='<li class="left clearfix chat-message"><span class="chat-img pull-left"><img src="'+n+'" alt="User Avatar" class="img-circle"/></span>'+'<div class="chat-message-left"><div class="header"><strong class="primary-font chat-username">'+s+"</strong> "+'<small class="pull-right text-muted">'+'<i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+o+'">'+o+"</abbr></small></div>"+"<p>"+e+"</p></div></li>"}else{var a='<li class="right clearfix chat-message"><span class="chat-img pull-right"><img src="'+t+'" alt="User Avatar" class="img-circle"/></span>'+'<div class="chat-message-right"><div class="header">'+'<small class="text-muted">'+'<i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+o+'">'+o+"</abbr></small>"+'<strong class="pull-right primary-font">You</strong>'+"</div><p>"+e+"</p></div></li>"}i.append(a);r.scrollTop(i.height());$("abbr.timeago").timeago()}function S(){var e={channel_token:channel_token,channel_id:channel_id};if($.browser.msie&&window.XDomainRequest){var t=new XDomainRequest;t.onload=function(){};t.onerror=function(){};t.ontimeout=function(){};t.onprogress=function(){};t.timeout=8e3;t.open("POST",welcomeChatURL);t.send($.param(e))}else{$.ajax({type:"POST",url:welcomeChatURL,data:e,crossDomain:true,dataType:"json",success:function(){},error:function(){}})}}var e=$("#gae-chat-variables");if(!e.length){return}connectedToChannel=false;chatHistory={};channel_errors=false;channel_retries=0;sendMessageURL=$("#send_message_url").attr("data-url");getTokenURL=$("#get_token_url").attr("data-url");onlineTestURL=$("#online_test_url").attr("data-url");onlineCheckURL=$("#send_online_check_url").attr("data-url");welcomeChatURL=$("#welcome_chat_url").attr("data-url");var t=$("#chat_customer_pic").attr("data-url");var n=$("#chat_employee_pic").attr("data-url");var r=$("#main-chat-body");var i=$("#main-chat-messages");var s=$("#main-chat-header");var o=s.find(".chat-status");var u=s.find(".chat-status-text");if(!Date.prototype.toISOString){(function(){function e(e){if(e<10){return"0"+e}return e}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+e(this.getUTCMonth()+1)+"-"+e(this.getUTCDate())+"T"+e(this.getUTCHours())+":"+e(this.getUTCMinutes())+":"+e(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}})()}$("#chat-send-message-btn").click(function(){var e=$("#chat-btn-input").val();if(e){g(e);$("#chat-btn-input").val("")}});$("#chat-btn-input").on("keyup",function(e){var t=$("#chat-btn-input").val();if(e.which==13&&t){g(t);$("#chat-btn-input").val("")}});s.on("click",function(e){if(e.target!=this){return}if($(this).hasClass("chat-minimized")){r.show();$(this).removeClass("chat-minimized");$("#min-main-chat-btn").html("<i class='icon-chevron-down'></i>")}});$("#min-main-chat-btn").on("click",function(e){if(s.hasClass("chat-minimized")){r.show();s.removeClass("chat-minimized");$(this).html("<i class='icon-chevron-down'></i>")}else{r.hide();s.addClass("chat-minimized");$(this).html("<i class='icon-chevron-up'></i>")}});$.timeago.settings.strings.seconds="seconds";b()});