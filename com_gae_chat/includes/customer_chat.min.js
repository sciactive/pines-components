pines(function(){function w(e,t){channel_id=e;channel_token=t;k()}function E(e){return(new Date(Number(e))).toISOString()}function S(e,t,n,r){chatHistory[e]={from_channel:t,message:n,username:r}}function x(){connectedToChannel=true;d.removeClass("offline checking");if(G=="open"&&$(window).width()>768){a.click()}h.removeClass("icon-spin icon-spinner icon-ban-circle");B();P()}function T(e){var t=jQuery.parseJSON(e.data);if(t!==undefined){if(t.type=="message"){D(t.message.message,t.message.from_username,E(t.message.timestamp),true,true);U()}else if(t.type=="customer_message"){S(t.message_id,t.from_channel,t.message,t.username);D(t.message,t.username,E(t.timestamp),false,true);U()}else if(t.type=="employee_message"){S(t.message_id,t.from_channel,t.message,t.username);D(t.message,t.username,E(t.timestamp),true,true);U()}else if(t.type=="online_check"){L()}else{s.append("<li><p>"+t.message+"</p></li>")}}}function N(e){if(e.code=="401"){channel_errors=true}}function C(){connectedToChannel=false;d.addClass("offline");t.addClass("chat-minimized");$("body").removeClass("chat-mobile-open");B();h.removeClass("icon-chevron-down icon-chevron-down icon-spin icon-spinner").addClass("icon-ban-circle");if(channel_errors&&channel_retries<5){channel_retries++;M("true")}}function k(){channel=new goog.appengine.Channel(channel_token);socket=channel.open();socket.onopen=x;socket.onmessage=T;socket.onerror=N;socket.onclose=C}function L(){var e={channel_id:channel_id,channel_token:channel_token};if($.browser.msie&&window.XDomainRequest){var t=new XDomainRequest;t.onload=function(){};t.onerror=function(){};t.ontimeout=function(){};t.onprogress=function(){};t.timeout=8e3;t.open("POST",onlineTestURL);t.send($.param(e))}else{$.ajax({type:"POST",url:onlineTestURL,data:e,crossDomain:true,dataType:"json",success:function(){},error:function(){}})}}function A(e){if(connectedToChannel){var t=(new Date).getTime();var n={channel_id:channel_id,msg:e,timestamp:t,channel_token:channel_token};if($.browser.msie&&window.XDomainRequest){var r=new XDomainRequest;r.onload=function(){var n=JSON.parse(r.responseText);if(n.status=="success"){D(e,n.username,E(t),false,false);S(n.message_id,channel_id,e,n.username);U()}};r.onerror=function(){s.append("<li><p>There was an error sending the message. Please try again</p></li>");i.scrollTop(s.height())};r.ontimeout=function(){s.append("<li><p>There was a timeout error. It took too long to send the message. Please try again</p></li>");i.scrollTop(s.height())};r.onprogress=function(){};r.timeout=8e3;r.open("POST",sendMessageURL);r.send($.param(n))}else{$.ajax({type:"POST",url:sendMessageURL,data:n,crossDomain:true,dataType:"json",success:function(n){if(n.status=="success"){D(e,n.username,E(t),false,false);U()}},error:function(){s.append("<li><p>There was an error sending the message. Please try again</p></li>");i.scrollTop(s.height())}})}}else{s.append("<li><p>Need to be connected to Chat to send messages</p></li>");i.scrollTop(s.height())}}function O(){t.remove();e.remove()}function M(e){d.removeClass("offline").addClass("checking");h.removeClass("icon-chevron-down icon-chevron-down icon-ban-circle").addClass("icon-spin icon-spinner");$.ajax({type:"POST",url:getTokenURL,data:{force_new_token:e},dataType:"json",success:function(e){if(e.status!="success"||e.action=="terminate"){O()}else{t.removeClass("hide");w(e.channel_id,e.channel_token)}},error:function(){s.append("<li><p>There was an error connecting to chat. Please refresh your page.</p></li>");i.scrollTop(s.height())}})}function _(e){var t=e.length;for(var n=0;n<t;n++){var r=e[n];if(!chatHistory[r.message_id]){D(r.message,r.from_username,E(r.timestamp),channel_id!=r.from_channel,false);S(r.message_id,r.from_channel,r.message,r.from_username)}}U()}function D(e,o,u,a,f){if(a){var l='<li class="left clearfix chat-message main-trans"><span class="chat-img pull-left"><img src="'+r+'" alt="User Avatar" class="img-circle"/></span>'+'<div class="chat-message-left"><div class="header"><strong class="primary-font chat-username">'+o+"</strong> "+'<small class="pull-right text-muted">'+'<i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+u+'">'+u+"</abbr></small></div>"+"<p>"+e+"</p></div></li>"}else{var l='<li class="right clearfix chat-message main-trans"><span class="chat-img pull-right"><img src="'+n+'" alt="User Avatar" class="img-circle"/></span>'+'<div class="chat-message-right"><div class="header">'+'<small class="text-muted">'+'<i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+u+'">'+u+"</abbr></small>"+'<strong class="pull-right primary-font">You</strong>'+"</div><p>"+e+"</p></div></li>"}s.append(l);i.scrollTop(s.height());$("abbr.timeago").timeago();if(f&&t.hasClass("chat-minimized")){s.find(".chat-message").last().addClass("flash")}}function P(){var e={channel_token:channel_token,channel_id:channel_id};if($.browser.msie&&window.XDomainRequest){var t=new XDomainRequest;t.onload=function(e){if(e.status=="success"){_(e.messages)}};t.onerror=function(){};t.ontimeout=function(){};t.onprogress=function(){};t.timeout=8e3;t.open("GET",getMessagesURL);t.send($.param(e))}else{$.ajax({type:"GET",url:getMessagesURL,data:e,crossDomain:true,dataType:"json",success:function(e){if(e.status=="success"){_(e.messages)}},error:function(){}})}}function H(e){var n=$(window).width();var r=$(window).height();var s=o.outerHeight();var f=$("#nav").outerHeight();var l=u.outerHeight();var c=a.outerHeight();var h=r-(f+s+l+c)-(i.outerHeight()-i.height())+10;var d=r-(c+f)+10;if(n<768&&!t.hasClass("chat-minimized")){$("html,body").addClass("chat-mobile-open");$("body").css("height",r+"px");p.css("height",d+"px");i.css("height",h+"px");I("main_chat_visibility")}else{$("html,body").removeClass("chat-mobile-open");$("body").removeAttr("style");p.add(i).removeAttr("style");if(n<768){I("main_chat_visibility")}}y=n;b=r}function B(){h.removeClass("icon-chevron-up icon-chevron-down");if(t.hasClass("chat-minimized")){h.addClass("icon-chevron-up")}else{h.addClass("icon-chevron-down")}}function j(e,t,n){if(n){var r=new Date;r.setTime(r.getTime()+n*24*60*60*1e3);var i="; expires="+r.toGMTString()}else var i="";document.cookie=e+"="+t+i+"; path=/"}function F(e){var t=e+"=";var n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r];while(i.charAt(0)==" ")i=i.substring(1,i.length);if(i.indexOf(t)==0)return i.substring(t.length,i.length)}return null}function I(e){j(e,"",-1)}function U(){var e=t.find(".chat-message");if(R){var n=F("main_chat_messages_num");if(n!==null){q=parseInt(n);var r=-1*q;e.slice(r).addClass("flash");W(q);J("on")}R=false}else{q=e.filter(".flash").length;j("main_chat_messages_num",q,1);if(q>0&&t.hasClass("chat-minimized")){W(q);J("on")}else{I("main_chat_messages_num");W(0);J("off")}}}function z(){var e=t.find(".chat-message");var n=F("main_chat_messages_num");if(n==null&&e.filter(".flash").length){e.removeClass("flash");U()}}function W(e){if(e>0){g.text(e);m.fadeIn()}else{m.fadeOut()}}function V(){var e=Q==1?q+" Unread Message!":q+" Unread Messages!";var t=v.attr("data-title");if(v.text()==t)v.text(e);else v.text(t);z();J("on")}function J(e){clearTimeout(X);if(e=="off"||q<1){v.text(v.attr("data-title"));return}X=setTimeout(V,1e3)}function Y(){pines(function(){var e=$("#main-chat-window");var t=$("#main-chat-notice");var n=true;var r=F("chat-loaded");if(r!=null){M();return}e.removeClass("hide");t.click(function(){if(n){n=false;j("chat-loaded","true",7);M()}});$(document).scroll(function(){if(n){j("chat-loaded","true",7);n=false;M()}})})}var e=$("#gae-chat-variables");if(!e.length){return}connectedToChannel=false;chatHistory={};channel_errors=false;channel_retries=0;sendMessageURL=$("#send_message_url").attr("data-url");getTokenURL=$("#get_token_url").attr("data-url");onlineTestURL=$("#online_test_url").attr("data-url");onlineCheckURL=$("#send_online_check_url").attr("data-url");getMessagesURL=$("#get_messages_url").attr("data-url");var t=$("#main-chat-window");var n=$("#chat_customer_pic").attr("data-url");var r=$("#chat_employee_pic").attr("data-url");var i=$("#main-chat-body");var s=$("#main-chat-messages");var o=$("#main-chat-header");var u=$("#main-chat-footer");var a=$("#main-chat-notice");var f=$("#chat-send-message-btn");var l=$("#chat-btn-input");var c=$(".main-chat-notice-toggle");var h=c.find("i");var p=t.find(".chat-container");var d=a.find(".chat-status");var v=$("title");var m=a.find(".main-chat-notice-messages");var g=a.find(".main-chat-notice-num-messages");var y=0;var b=0;if(!Date.prototype.toISOString){(function(){function e(e){if(e<10){return"0"+e}return e}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+e(this.getUTCMonth()+1)+"-"+e(this.getUTCDate())+"T"+e(this.getUTCHours())+":"+e(this.getUTCMinutes())+":"+e(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}})()}var q=0;var R=true;var X=null;f.click(function(){var e=l.val();if(e){H(false);A(e);l.val("")}});l.on("keyup",function(e){var t=l.val();if(e.which==13&&t){A(t);l.val("")}});a.on("click",function(e){if(c.hasClass("offline")||c.hasClass("checking"))return;if(t.hasClass("chat-minimized")){t.attr("data-offset",window.pageYOffset);$("html,body").animate({scrollTop:0},100);t.removeClass("chat-minimized");c.html("<i class='icon-chevron-down'></i>");U();var n=$(".chat-message").filter(".flash");setTimeout(function(){n.removeClass("flash")},4e3);j("main_chat_visibility","open",2)}else{$("html,body").animate({scrollTop:parseInt(t.attr("data-offset"))},400);t.addClass("chat-minimized");c.html("<i class='icon-chevron-up'></i>");j("main_chat_visibility","closed",2)}H(false)});$(window).resize(function(){H(true);if(!t.hasClass("chat-minimized")){var e=document.getElementById("main-chat-body");i.animate({scrollTop:e.scrollHeight},300)}}).resize();var K=F("main_chat_messages_num");var Q=K!=null?K:0;var G=F("main_chat_visibility");v.attr("data-title",v.text());$.timeago.settings.strings.seconds="seconds";if(window.addEventListener)window.addEventListener("load",Y,false);else if(window.attachEvent)window.attachEvent("onload",Y);else window.onload=Y})