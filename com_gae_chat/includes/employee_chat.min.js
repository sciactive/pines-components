pines(function(){function n(n,e,t){if(displayNotifications)if("granted"===Notification.permission){new Notification(n,{body:e,tag:t})}else"denied"!==Notification.permission&&Notification.requestPermission(function(i){if("permission"in Notification||(Notification.permission=i),"granted"===i){new Notification(n,{body:e,tag:t})}})}function e(n,e,t,i){channel_id=n,channel_token=e,channel_username=t,channel_guid=i,o()}function t(){D.removeClass("offline checking"),I.html("Online"),connectedToChannel=!0,b()}function i(n){var e=JSON.parse(n.data);void 0!==e&&("connection"==e.type?(U(e.user),j(e.user.channel_id),r(e.user.channel_id)):"disconnection"==e.type?g(e.channel_id):"message"==e.type?z(e.message):"online_check"==e.type?m(e):"customer_check"==e.type?h(e):"customer_update"==e.type?x(e.user):"connection_update"==e.type&&d(e.connected_clients,e.disconnected_clients))}function a(n){"401"==n.code&&(needToRestartChannels=!0)}function s(){D.removeClass("checking").addClass("offline"),connectedToChannel=!1,needToRestartChannels&&c()}function c(){needToRestartChannels=!1,y("true")}function o(){channel=null,socket=null,channel=new goog.appengine.Channel(channel_token),socket=channel.open(),socket.onopen=t,socket.onmessage=i,socket.onerror=a,socket.onclose=s}function l(){for(var n=F.length,e=0;n>e;e++){var t,i,a="#"+F[e];if(0==e)t=J+e*H*100+2,i=t.toString()+"%";else{var s="#"+F[0],c=$(s).width()/$(window).width();t=J+e*c*100+(e+1+E),i=t.toString()+"%"}$(a).css("right",i),$(a).show(),$(a+"-chat-body").show()}}function d(n,e){for(var t=n.length,i=e.length,a=0;t>a;a++){var s=n[a];if($("#"+s+"-div").show(),$("#"+s).find(".chat-status").removeClass("offline checking"),"undefined"!=typeof disconnect_timeouts[s]&&disconnect_timeouts[s].length){for(var c in disconnect_timeouts[s])clearTimeout(c);disconnect_timeouts[s]=[]}}for(var a=0;i>a;a++){var o=e[a];$("#"+o+"-div").hide(),$("#"+s).find(".chat-status").removeClass("checking").addClass("offline")}}function r(n){n!==channel_id&&"undefined"===customer_chat_histories[n]&&$.ajax({type:"GET",url:getMessagesURL,data:{customer_channel:n,channel_token:channel_token,channel_id:channel_id},crossDomain:!0,dataType:"json",success:function(e){"success"===e.status&&(customer_chat_histories[n]=!0,k(e.messages))},error:function(){}})}function h(n){var e="#"+n.channel_id+"-div";if($(e).show(),$("#"+n.channel_id).find(".chat-status").removeClass("offline checking"),"undefined"==typeof disconnect_timeouts[n.channel_id])return void(disconnect_timeouts[n.channel_id]=[]);if(disconnect_timeouts[n.channel_id].length){for(var t in disconnect_timeouts[n.channel_id])clearTimeout(t);disconnect_timeouts[n.channel_id]=[]}"undefined"!=typeof n.page_url&&R(e,n.page_url)}function u(n){$("#"+n).find(".chat-status").removeClass("offline").addClass("checking"),"undefined"==typeof disconnect_timeouts[n]&&(disconnect_timeouts[n]=[]);var e=setTimeout(function(){disconnect_timeouts[n].length&&($("#"+n).find(".chat-status").removeClass("checking").addClass("offline"),disconnect_timeouts[n]=[])},5e3);disconnect_timeouts[n].push(e),$.ajax({type:"POST",url:onlineCheckURL,data:{customer_channel:n,channel_token:channel_token,channel_id:channel_id},crossDomain:!0,dataType:"json",success:function(){},error:function(){}})}function m(){$.ajax({type:"POST",url:onlineTestURL,data:{channel_token:channel_token,channel_id:channel_id},crossDomain:!0,dataType:"json",success:function(){},error:function(){}})}function f(n){var e=n.length;if(e)for(var t=0;e>t;t++)U(n[t])}function _(n){return new Date(Number(n)).toISOString()}function p(n){if(displayNotifications){var e=setInterval(function(){$(n).hasClass("alert-info")?$(n).removeClass("alert-info"):$(n).addClass("alert-info")},1e3),t=setTimeout(function(){clearInterval(e),$(n).addClass("alert-info")},5e3);$(n).on("click",function(){clearInterval(e),clearTimeout(t),$(n).removeClass("alert-info")})}}function g(n){"undefined"==typeof disconnect_timeouts[n]&&(disconnect_timeouts[n]=[]);var e=setTimeout(function(){$("#"+n).find(".chat-status").removeClass("checking").addClass("offline"),$("#"+n+"-div").hide(),disconnect_timeouts[n]=[]},1e4);disconnect_timeouts[n].push(e)}function v(n,e){if(connectedToChannel){var t=(new Date).getTime();$.ajax({type:"POST",url:sendMessageURL,data:{to_channel:e,msg:n,from_channel:channel_id,timestamp:t,channel_token:channel_token,channel_id:channel_id},crossDomain:!0,dataType:"json",success:function(){},error:function(){$("#"+e+"-chat").append("<li><p>There was an error sending the message.</p></li>")}})}else y()}function y(n){D.removeClass("offline").addClass("checking"),I.html("Connecting");var t=getTokenURL;$.ajax({type:"POST",url:t,data:{force_new_token:n},dataType:"json",success:function(n){e(n.channel_id,n.channel_token,n.username,n.guid)},error:function(){alert("Could not get a token. Please refresh your page")}})}function k(n){var e=n.length;if(e){displayNotifications=!1;for(var t=0;e>t;t++){var i=n[t];"undefined"==typeof chatHistory[i.message_id]&&$("#"+i.channel_id).length&&z(i)}displayNotifications=!0}}function b(){$.ajax({type:"GET",url:getUsersPlusMessagesURL,data:{token:channel_token,channel_id:channel_id},dataType:"json",crossDomain:!0,success:function(n){if("success"==n.status)for(var e=n.users.length,t=0;e>t;t++)U(n.users[t].user),j(n.users[t].user.channel_id),k(n.users[t].messages)},error:function(){}})}function C(){for(var n in connected_clients)disconnect_timeouts[n.channel_id]=[];setTimeout(function(){for(var n in connected_clients)disconnect_timeouts[n.channel_id].length&&w(n)},8e3),$.ajax({type:"POST",url:pingAllCustomersURL,data:{channel_token:channel_token,channel_id:channel_id},dataType:"json",crossDomain:!0,success:function(){},error:function(){}})}function w(n){$(connected_clients[n].chat_div).hide(),$(connected_clients[n].chat_window).find(".chat-status").removeClass("checking").addClass("offline")}function T(){$.ajax({type:"GET",url:refreshOnlineUsersURL,data:{channel_token:channel_token,channel_id:channel_id},dataType:"json",crossDomain:!0,success:function(n){"success"==n.status&&f(n.users)},error:function(){}})}function x(n){if("undefined"!=typeof n){var e=connected_clients[n.channel_id];0===Object.keys(e).length&&(connected_clients[n.channel_id]={});for(var t in n)n.hasOwnProperty(t)&&(connected_clients[n.channel_id][t]=n[t]);var i="#"+n.channel_id+"-div";N(i,n.city,n.region)}}function U(n){if(n.channel_id!=channel_id){var e=disconnect_timeouts[n.channel_id];if("undefined"!=typeof e&&e.length){for(var t in disconnect_timeouts[n.channel_id])clearTimeout(t);disconnect_timeouts[n.channel_id]=[]}connected_clients[n.channel_id]={};for(var i in n)n.hasOwnProperty(i)&&(connected_clients[n.channel_id][i]=n[i]);var a=n.channel_id+"-div";if($("#"+a).length)return $("#"+a).show(),void $("#"+n.channel_id).find(".chat-status").removeClass("offline checking");if(Boolean(n.is_employee)){var s='<div class="list-group employee-channel-clients-list channel-client-list" id="'+n.channel_id+'-div" data-channelid="'+n.channel_id+'"><a class="list-group-item channel-name-div"><strong class="chat-client-div-username">'+n.username+'</strong><input type="text" style="display:none;" value="'+n.channel_id+'"/></a></div>';$("#employee-chat-clients").append(s)}else{var c="nondistinguished-chat-user";Boolean(n.distinguished)&&(c="distinguished-chat-user");var o=n.username;if(Boolean(n.username_link)){var l=/[\?\&\=]/;l.test(n.username_link)&&(o='<a href="'+n.username_link+'" target="_blank">'+n.username+"</a>")}connected_clients[n.channel_id].username_link=o;var d='<span class="chat-client-div-info badge"></span>';n.city&&(d='<span class="chat-client-div-info badge">'+n.city.capitalize()+", "+n.region.capitalize()+"</span>");var r='<div class="list-group customer-channel-clients-list channel-client-list '+c+'" id="'+n.channel_id+'-div" data-channelid="'+n.channel_id+'"><div class="list-group-item channel-name-div"><strong class="chat-client-div-username">'+n.username+"</strong>"+d+'<p class="last-chat-message chat-ellipsis"></p><p class="last-page-url chat-ellipsis"><a href="'+n.page_url+'" target="_blank">'+n.page_url+'</a></p><input type="text" style="display:none;" value="'+n.channel_id+'"/></div></div>';$("#customer-chat-clients").append(r)}}}function z(e){var t,i,a,s,c=e.from_channel===channel_id,o=_(e.timestamp),l=e.from_username;Boolean(e.channel_id)?(t="#"+e.channel_id+"-chat",a="#"+e.channel_id+"-chat-body",s="#"+e.channel_id+"-div"):c?Boolean(e.employee_to_employee)?(t="#"+e.to_channel+"-chat",a="#"+e.to_channel+"-chat-body",s="#"+e.to_channel+"-div"):(t="#"+e.channel_id+"-chat",a="#"+e.channel_id+"-chat-body",s="#"+e.channel_id+"-div"):(t="#"+e.from_channel+"-chat",a="#"+e.from_channel+"-chat-body",s="#"+e.from_channel+"-div"),c?i='<li class="chat-message"><span class="chat-img pull-right"><img src="'+L+'" alt="User Avatar" class="img-circle"/></span><div class="chat-message-right clearfix"><div class="header"><small class="text-muted"><i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+o+'">'+o+'</abbr></small><strong class="pull-right primary-font">'+l+"</strong></div><p>"+e.message+"</p></div></li>":(i='<li class="chat-message"><span class="chat-img pull-left"><img src="'+O+'" alt="User Avatar" class="img-circle"/></span><div class="chat-message-left clearfix"><div class="header"><strong class="primary-font">'+l+'</strong> <small class="pull-right text-muted"><i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+o+'">'+o+"</abbr></small></div><p>"+e.message+"</p></div></li>",R(s,e.page_url),n(l,e.message,l),p(s)),$(t).append(i),$(a).scrollTop($(t).height()),$(s).find(".last-chat-message").html(e),chatHistory[e.message_id]=e,$("abbr.timeago").timeago()}function R(n,e){"undefined"!=typeof e&&Boolean(e)&&$(n).find(".last-page-url").html('<a href="'+e+'" target="_blank">'+e+"</a>")}function N(n,e,t){$(n).find(".badge").html(e.capitalize()+", "+t.capitalize())}function j(n){if(!$("#"+n).length&&n!=channel_id){var e=connected_clients[n],t='<div style="display: none;" class="container chat-window chat-container" id="'+n+'"><div class="row chat-header" data-channelid="'+n+'"><span class="chat-status"></span><span class="chat-username">'+e.username_link+'</span><div class="btn-group pull-right"><button type="button" class="btn btn-small min-max-btn" data-channelid="'+n+'"><i class="icon-chevron-down"></i></button><button type="button" class="btn btn-small close-chat-btn" data-channelid="'+n+'"><i class="icon-remove"></i></button><button type="button" class="btn btn-small dropdown-toggle" data-toggle="dropdown"><i class="icon-wrench"></i></button><ul class="dropdown-menu slidedown"><li><a href="#" class="do-online-check" data-channelid="'+n+'"><i class="icon-chevron-right"></i> Online Check</a></li></ul></div></div><div class="row chat-body" id="'+n+'-chat-body"><ul class="chat-window-messages" id="'+n+'-chat"></ul></div><div class="row chat-footer"><div class="input-append chat-message-input"><input id="'+n+'-btn-input" data-channelid="'+n+'" type="text" class="form-control chat-input-box" placeholder="Type Message Here..."><span class="input-group-btn"><button  type="button" class="btn btn-warning chat-button send-chat-btn" data-channelid="'+n+'">Send</button></span></div></div></div>';additionalClients.append(t),l()}}var S=$("#gae-chat-variables");if(S.length){sendMessageURL=$("#send_message_url").attr("data-url"),getTokenURL=$("#get_token_url").attr("data-url"),onlineTestURL=$("#online_test_url").attr("data-url"),onlineCheckURL=$("#send_online_check_url").attr("data-url"),pingAllCustomersURL=$("#ping_all_customers_url").attr("data-url"),refreshOnlineUsersURL=$("#refresh_online_users_url").attr("data-url"),getMessagesURL=$("#get_customer_messages_url").attr("data-url"),getUsersPlusMessagesURL=$("#get_users_and_messages_url").attr("data-url"),minMainChatBtn=$("#min-main-chat-btn"),additionalClients=$("#additional_clients"),displayNotifications=!1,disconnect_timeouts={},customer_chat_histories={},connectedToChannel=!1,connected_clients={},extra_clients={},chatHistory={},needToRestartChannels=!1;var L=$("#chat_customer_pic").attr("data-url"),O=$("#chat_employee_pic").attr("data-url"),P=$("#main-chat-window"),M=$("#main-chat-body"),B=$("#main-chat-header"),D=B.find(".chat-status"),I=B.find(".chat-status-text"),A=$(window).width(),H=P.width()/A,E=1,G=parseInt(P.css("right")),q=(P.width()+G)/$(window).width(),J=100*q,F=[];String.prototype.capitalize=function(){return this.replace(/(?:^|\s)\S/g,function(n){return n.toUpperCase()})},additionalClients.on("keyup",".chat-input-box",function(n){if(13==n.which){var e=$(this).attr("data-channelid"),t=$(this).val();t&&(v(t,e),$(this).val(""))}}),additionalClients.on("click",".chat-button",function(){var n=$(this).attr("data-channelid"),e="#"+n+"-btn-input",t=$(e).val();t&&(v(t,n),$(e).val(""))}),M.on("click",".channel-client-list",function(){var n=$(this).attr("data-channelid");$("#"+n).length?-1===F.indexOf(n)&&F.push(n):(j(n),F.push(n)),l()}),minMainChatBtn.click(function(){M.hasClass("chat-minimized")?(M.removeClass("chat-minimized").show(),$(this).html('<i class="icon-chevron-down"></i>'),localStorage.setItem("chatminimized","no")):(M.addClass("chat-minimized").hide(),$(this).html('<i class="icon-chevron-up"></i>'),localStorage.setItem("chatminimized","yes"))}),additionalClients.on("click",".min-max-btn",function(){var n="#"+$(this).attr("data-channelid")+"-chat-body";$(n).hasClass("chat-minimized")?($(n).show(),$(this).parent().parent().removeClass("chat-minimized"),$(n).removeClass("chat-minimized"),$(this).html("<i class='icon-chevron-down'></i>")):($(n).hide(),$(this).parent().parent().addClass("chat-minimized"),$(n).addClass("chat-minimized"),$(this).html("<i class='icon-chevron-up'></i>"))}),additionalClients.on("click",".close-chat-btn",function(){var n=$(this).attr("data-channelid"),e=F.indexOf(n);F.splice(e,1),$("#"+n).hide(),l()}),additionalClients.on("click",".chat-header",function(n){n.target==this&&$(this).hasClass("chat-minimized")&&($(this).find(".min-max-btn").html('<i class="icon-chevron-down"></i>'),$(this).parent().find(".chat-body").show().removeClass("chat-minimized"),$(this).removeClass("chat-minimized"))}),B.on("click",function(n){n.target==this&&M.hasClass("chat-minimized")&&(minMainChatBtn.html('<i class="icon-chevron-down"></i>'),M.removeClass("chat-minimized").show(),localStorage.setItem("chatminimized","no"))}),additionalClients.on("click",".do-online-check",function(){var n=$(this).attr("data-channelid");u(n)}),$("#enableNotifications").click(function(n){n.target==this&&"denied"!==Notification.permission&&Notification.requestPermission(function(n){"permission"in Notification||(Notification.permission=n)})}),$("#ping_all_customers").click(function(n){n.target==this&&C()}),$("#refresh_online_users_list").click(function(n){n.target==this&&T()}),"yes"==localStorage.getItem("chatminimized")&&minMainChatBtn.click(),$.timeago.settings.strings.seconds="seconds",$("abbr.timeago").timeago(),y()}});