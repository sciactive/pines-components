pines(function(){function v(e,t,n){if(!displayNotifications){return}if(Notification.permission==="granted"){var r=new Notification(e,{body:t,tag:n})}else if(Notification.permission!=="denied"){Notification.requestPermission(function(r){if(!("permission"in Notification)){Notification.permission=r}if(r==="granted"){var i=new Notification(e,{body:t,tag:n})}})}}function m(e,t,n,r,i){if(!connected_clients[t]){connected_clients[t]={username:n}}chatHistory[e]={from_channel:t,username:n,timestamp:r,message:i}}function g(e,t,n,r){channel_id=e;channel_token=t;channel_username=n;channel_guid=r;N()}function y(){o.removeClass("offline checking");u.html("Online");connectedToChannel=true}function b(e){var t=JSON.parse(e.data);if(t!==undefined){if(t.type=="customer_connect"){U(t,false);k(t)}else if(t.type=="customer_disconnect"){F(t)}else if(t.type=="employee_connect"){U(t,true)}else if(t.type=="employee_disconnect"){F(t)}else if(t.type=="customer_message"){j(t,false)}else if(t.type=="employee_message"){B(t,true)}else if(t.type=="employee_to_employee"){H(t,true)}else if(t.type=="online_users"){M(t)}else if(t.type=="online_check"){O(t)}else if(t.type=="customer_check"){L(t)}else if(t.type=="message_history"){k(t);displayNotifications=true}else if(t.type=="customer_update"){S(t.channel_id,t.city,t.region,t.page_url)}else{j(t)}}else{}}function w(e){if(e.code=="401"){needToRestartChannels=true}}function E(){o.removeClass("checking").addClass("offline");connectedToChannel=false;if(needToRestartChannels){x()}}function S(e,t,n,r){var i=$("#"+e+"-div");if(!i.length)return;i.find(".chat-client-div-info").html(t.capitalize()+", "+n.capitalize());i.find(".last-page-url").html('<a href="'+r+'" target="_blank">'+r+"</a>")}function x(){needToRestartChannels=false;q(true)}function T(){document.getElementById("channel-notification").pause();document.getElementById("channel-notification").play()}function N(){channel=null;socket=null;channel=new goog.appengine.Channel(channel_token);socket=channel.open();socket.onopen=y;socket.onmessage=b;socket.onerror=w;socket.onclose=E}function C(){var e=d.length;for(var t=0;t<e;t++){var n="#"+d[t];if(t==0){var r=p+t*f*100+2;var i=r.toString()+"%"}else{var s="#"+d[0];var o=$(s).width()/$(window).width();var r=p+t*o*100+(t+1+l);var i=r.toString()+"%"}$(n).css("right",i);$(n).show();$(n+"-chat-body").show()}}function k(e){if(!e.messages){return}var t=e.messages.length;if(t<1){return}displayNotifications=false;for(var n=0;n<t;n++){var r=e.messages[n];if(!chatHistory[r.message_id]){W(r.channel_id);z(r.channel_id,r.message,r.from_username,_(r.timestamp),"#"+r.channel_id+"-chat",r.from_channel==channel_id,r.message_id);if(r.page_url){$("#"+r.channel_id+"-div").find(".last-page-url").html('<a href="'+r.page_url+'" target="_blank">'+r.page_url+"</a>")}}}displayNotifications=true}function L(e){$("#"+e.channel_id+"-div").show();$("#"+e.channel_id).find(".chat-status").removeClass("offline checking");connected_clients[e.channel_id].checking_online=false;U(e,false)}function A(e){$("#"+e).find(".chat-status").removeClass("offline").addClass("checking");connected_clients[e].checking_online=true;$.ajax({type:"POST",url:onlineCheckURL,data:{customer_channel:e,channel_token:channel_token},crossDomain:true,dataType:"json",success:function(){setTimeout(function(){if(connected_clients[e].checking_online){$("#"+e).find(".chat-status").removeClass("checking").addClass("offline");connected_clients[e].checking_online=false}else{}},5e3)},error:function(){}})}function O(){$.ajax({type:"POST",url:onlineTestURL,data:{channel_token:channel_token},crossDomain:true,dataType:"json",success:function(){},error:function(){}})}function M(e){var t=e.online_users.length;var n=e.online_employees.length;for(var r=0;r<t;r++){U(e.online_users[r],false)}for(var r=0;r<n;r++){U(e.online_employees[r],true)}}function _(e){return(new Date(Number(e))).toISOString()}function D(e){return document.contains(document.getElementById(e))}function P(e){var t=setInterval(function(){if($(e).hasClass("alert-info")){$(e).removeClass("alert-info")}else{$(e).addClass("alert-info")}},1e3);var n=setTimeout(function(){clearInterval(t);$(e).addClass("alert-info")},5e3);$(e).on("click",function(){clearInterval(t);clearTimeout(n);$(e).removeClass("alert-info")})}function H(e){if(e.from_channel==channel_id){if(document.contains(document.getElementById(e.to_channel))){var t="#"+e.to_channel+"-chat";z(e.to_channel,e.message,channel_username,_(e.timestamp),t,true,e.message_id)}else{W(e.to_channel);H(e)}}else{if(document.contains(document.getElementById(e.from_channel))){var t="#"+e.from_channel+"-chat";z(e.from_channel,e.message,e.username,_(e.timestamp),t,false,e.message_id);P("#"+e.from_channel+"-div")}else{W(e.from_channel);H(e)}}}function B(e){if(D(e.to_channel)){var t="#"+e.to_channel+"-chat";var n=false;if(e.from_channel==channel_id){n=true}z(e.to_channel,e.message,e.username,_(e.timestamp),t,n,e.message_id);if(!n)P("#"+e.to_channel+"-div")}else{W(e.to_channel);B(e)}}function j(e){if(D(e.from_channel)){var t="#"+e.from_channel+"-chat";var n="#"+e.from_channel+"-div";z(e.from_channel,e.message,e.username,_(e.timestamp),t,false,e.message_id);if(e.page_url){$(n).find(".last-page-url").html('<a href="'+e.page_url+'" target="_blank">'+e.page_url+"</a>")}P(n)}else{W(e.from_channel);j(e)}}function F(e){var t=e.channel_id;if(!Boolean(connected_clients[t])){connected_clients[t]={}}var n=setTimeout(function(){$("#"+t).find(".chat-status").removeClass("checking").addClass("offline");$("#"+t+"-div").hide();connected_clients[t].disconnect_timeout=null},1e4);connected_clients[t].disconnect_timeout=n}function I(e,t){if(connectedToChannel){var n=(new Date).getTime();$.ajax({type:"POST",url:sendMessageURL,data:{to_channel:t,msg:e,from_channel:channel_id,timestamp:n,channel_token:channel_token},crossDomain:true,dataType:"json",success:function(){},error:function(e){$("#"+t+"-chat").append("<li><p>There was an error sending the message.</p></li>")}})}else{q()}}function q(e){o.removeClass("offline").addClass("checking");u.html("Connecting");var t=getTokenURL;$.ajax({type:"POST",url:t,data:{force_new_token:e},dataType:"json",success:function(e){g(e.channel_id,e.channel_token,e.username,e.guid)},error:function(){alert("Could not get a token. Please refresh your page")}})}function R(e){if(!connected_clients[e.channel_id]){connected_clients[e.channel_id]={username:e.username,token:e.token,online_status:false,city:e.city,region:e.region,header:"header_div",chat_body:"chat_body_div",online_icon:"online_icon_status",checking_online:false,username_link:e.username_link,page_url:e.page_url}}}function U(e,t){var n=connected_clients[e.channel_id];if(Boolean(n)&&Boolean(n.disconnect_timeout)){clearTimeout(connected_clients[e.channel_id].disconnect_timeout);connected_clients[e.channel_id].disconnect_timeout=null;return}R(e);if(e.channel_id==channel_id){return}var r=e.channel_id+"-div";if(D(r)){$("#"+r).show();$("#"+e.channel_id).find(".chat-status").removeClass("offline checking");return}if(t){var i='<div class="list-group employee-channel-clients-list channel-client-list" id="'+e.channel_id+'-div" data-channelid="'+e.channel_id+'"><a class="list-group-item channel-name-div">'+'<strong class="chat-client-div-username">'+e.username+"</strong>"+'<input type="text" style="display:none;" value="'+e.channel_id+'"/>'+"</a></div>";$("#employee-chat-clients").append(i)}else{var s="nondistinguished-chat-user";if(e.distinguished){s="distinguished-chat-user"}var o=e.username;if(Boolean(e.username_link)){var u=/[\?\&\=]/;if(u.test(e.username_link)){o='<a href="'+e.username_link+'" target="_blank">'+e.username+"</a>"}}connected_clients[e.channel_id].username_link=o;var a='<span class="chat-client-div-info badge"></span>';if(e.city){a='<span class="chat-client-div-info badge">'+e.city.capitalize()+", "+e.region.capitalize()+"</span>"}var f='<div class="list-group customer-channel-clients-list channel-client-list '+s+'" id="'+e.channel_id+'-div" data-channelid="'+e.channel_id+'"><div class="list-group-item channel-name-div">'+'<strong class="chat-client-div-username">'+e.username+"</strong>"+a+'<p class="last-chat-message chat-ellipsis"></p>'+'<p class="last-page-url chat-ellipsis"><a href="'+e.page_url+'" target="_blank">'+e.page_url+"</a>"+"</p>"+'<input type="text" style="display:none;" value="'+e.channel_id+'"/>'+"</div></div>";$("#customer-chat-clients").append(f)}}function z(e,r,i,s,o,u,a){if(u){var f='<li class="chat-message"><span class="chat-img pull-right"><img src="'+t+'" alt="User Avatar" class="img-circle"/></span>'+'<div class="chat-message-right clearfix"><div class="header">'+'<small class="text-muted">'+'<i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+s+'">'+s+"</abbr></small>"+'<strong class="pull-right primary-font">'+i+"</strong>"+"</div><p>"+r+"</p></div></li>"}else{v(i,r,i);var f='<li class="chat-message"><span class="chat-img pull-left"><img src="'+n+'" alt="User Avatar" class="img-circle"/></span>'+'<div class="chat-message-left clearfix"><div class="header"><strong class="primary-font">'+i+"</strong> "+'<small class="pull-right text-muted">'+'<i class="icon-time"></i><abbr class="timeago chat-timeago" title="'+s+'">'+s+"</abbr></small></div>"+"<p>"+r+"</p></div></li>"}$(o).append(f);$("#"+e+"-chat-body").scrollTop($(o).height());$("abbr.timeago").timeago();m(a,e,i,s,r);$("#"+e+"-div").find(".last-chat-message").html(r)}function W(e){if(document.contains(document.getElementById(e))){return}var t='<div style="display: none;" class="container chat-window chat-container" id="'+e+'"><div class="row chat-header" data-channelid="'+e+'">'+'<span class="chat-status"></span><span class="username">'+connected_clients[e].username_link+'</span><div class="btn-group pull-right">'+'<button type="button" class="btn btn-small min-max-btn" data-channelid="'+e+'"><i class="icon-chevron-down"></i></button>'+'<button type="button" class="btn btn-small close-chat-btn" data-channelid="'+e+'"><i class="icon-remove"></i></button>'+'<button type="button" class="btn btn-small dropdown-toggle" data-toggle="dropdown">'+'<i class="icon-wrench"></i></button><ul class="dropdown-menu slidedown"><li>'+'<a href="#" class="do-online-check" data-channelid="'+e+'"><i class="icon-chevron-right"></i> Online Check</a></li></ul>'+'</div></div><div class="row chat-body" id="'+e+'-chat-body">'+'<ul class="chat-window-messages" id="'+e+'-chat"></ul></div><div class="row chat-footer">'+'<div class="input-append chat-message-input"><input id="'+e+'-btn-input" data-channelid="'+e+'" type="text" class="form-control chat-input-box" placeholder="Type Message Here...">'+'<span class="input-group-btn"><button  type="button" class="btn btn-warning chat-button send-chat-btn" data-channelid="'+e+'">Send</button>'+"</span></div></div></div>";$("#additional_clients").append(t);C()}var e=$("#gae-chat-variables");if(!e.length){return}sendMessageURL=$("#send_message_url").attr("data-url");getTokenURL=$("#get_token_url").attr("data-url");onlineTestURL=$("#online_test_url").attr("data-url");onlineCheckURL=$("#send_online_check_url").attr("data-url");minMainChatBtn=$("#min-main-chat-btn");displayNotifications=false;connectedToChannel=false;connected_clients={};extra_clients={};chatHistory={};needToRestartChannels=false;var t=$("#chat_customer_pic").attr("data-url");var n=$("#chat_employee_pic").attr("data-url");var r=$("#main-chat-window");var i=$("#main-chat-body");var s=$("#main-chat-header");var o=s.find(".chat-status");var u=s.find(".chat-status-text");var a=$(window).width();var f=r.width()/a;var l=1;var c=parseInt(r.css("right"));var h=(r.width()+c)/$(window).width();var p=h*100;var d=[];String.prototype.capitalize=function(){return this.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})};$("#additional_clients").on("keyup",".chat-input-box",function(e){if(e.which==13){var t=$(this).attr("data-channelid");var n=$(this).val();if(n){I(n,t);$(this).val("")}}});$("#additional_clients").on("click",".chat-button",function(e){var t=$(this).attr("data-channelid");var n="#"+t+"-btn-input";var r=$(n).val();if(r){I(r,t);$(n).val("")}});i.on("click",".channel-client-list",function(){var e=$(this).attr("data-channelid");if(D(e)){if(d.indexOf(e)===-1){d.push(e)}}else{W(e);d.push(e)}C()});minMainChatBtn.click(function(){if(i.hasClass("chat-minimized")){i.removeClass("chat-minimized").show();$(this).html('<i class="icon-chevron-down"></i>');localStorage.setItem("chatminimized","no")}else{i.addClass("chat-minimized").hide();$(this).html('<i class="icon-chevron-up"></i>');localStorage.setItem("chatminimized","yes")}});$("#additional_clients").on("click",".min-max-btn",function(){var e="#"+$(this).attr("data-channelid")+"-chat-body";if($(e).hasClass("chat-minimized")){$(e).show();$(this).parent().parent().removeClass("chat-minimized");$(e).removeClass("chat-minimized");$(this).html("<i class='icon-chevron-down'></i>")}else{$(e).hide();$(this).parent().parent().addClass("chat-minimized");$(e).addClass("chat-minimized");$(this).html("<i class='icon-chevron-up'></i>")}});$("#additional_clients").on("click",".close-chat-btn",function(e){var t=$(this).attr("data-channelid");var n=d.indexOf(t);d.splice(n,1);$("#"+t).hide();C()});$("#additional_clients").on("click",".chat-header",function(e){if(e.target!=this){return}if($(this).hasClass("chat-minimized")){$(this).find(".min-max-btn").html('<i class="icon-chevron-down"></i>');$(this).parent().find(".chat-body").show().removeClass("chat-minimized");$(this).removeClass("chat-minimized")}});s.on("click",function(e){if(e.target!=this){return}if(i.hasClass("chat-minimized")){minMainChatBtn.html('<i class="icon-chevron-down"></i>');i.removeClass("chat-minimized").show();localStorage.setItem("chatminimized","no")}});$("#additional_clients").on("click",".do-online-check",function(){var e=$(this).attr("data-channelid");A(e)});$("#enableNotifications").click(function(e){if(e.target!=this){return}if(Notification.permission!=="denied"){Notification.requestPermission(function(e){if(!("permission"in Notification)){Notification.permission=e}})}});if(localStorage.getItem("chatminimized")=="yes"){minMainChatBtn.click()}$.timeago.settings.strings.seconds="seconds";$("abbr.timeago").timeago();q()});