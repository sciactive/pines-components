$(window).load(function(){var e=$("#p_mailer_send_email");var t=e.attr("data-url");var n=function(){$.ajax({url:t,type:"POST",dataType:"html",success:function(t){if(t=="")return;e.html(t);r()}})};var r=function(){function M(){var e=r.find("tr.ui-state-default").first().attr("title");var t=$("[data-entity="+e+"]").attr("data-entity-context");return t}function _(e,t,n){var r=$("<div></div>");var i='<div style="width:'+e+'%" class="bar '+n+'"></div>';for(var s=0;s<t;s++){r.append(i)}return r.html()}function D(e,t,n,r){var i=e/t*100;var s=i<8?"absolute-badge":"";var o='<span class="badge '+n+" "+s+'">'+e+"</span>";var u=$('<div style="width:'+i+'%; position:relative;" class="bar '+r+'"></div>');u.html(o);return u}function P(){var e={};e.email_template=s.find("[name=template]").val();e.guids=s.find("[name=guids]").val();e.entity_class=s.find("[name=entity_class]").val();e.sender=s.find("[name=sender]").val();e.custom_message=s.find("[name=custom_message]").val();$.ajax({url:f,type:"POST",dataType:"json",data:e,beforeSend:function(){S.hide();T.add(C).add(N).hide();x.html("");l.html('<i class="icon-spin icon-spinner"></i> Sending')},error:function(){return},success:function(t){w.hide();E.removeClass("btn-info").addClass("btn-success");var n=JSON.parse(e.guids).length;var r=100/n;if(!t){x.append(_(r,n,"bar-danger"));C.show()}else if(t.failed>0||t.skipped>0){O.hide();var i;if(t.sent>0){i=D(t.sent,n,"badge-success","bar-success");x.append(i);h.text("Sent");O.filter(".text-success").show()}if(t.skipped>0){i=D(t.skipped,n,"badge-warning","bar-warning");x.append(i);O.filter(".text-warning").show()}if(t.failed>0){i=D(t.failed,n,"badge-important","bar-danger");x.append(i);O.filter(".text-error").show()}k.text(t.sent);L.text(t.skipped);A.text(t.failed);T.show()}else{x.append(_(r,n,"bar-success"));N.show();h.text("Sent")}c.hide();S.fadeIn()}})}var e=$("#p_mailer_send_email");var t=e.find(".mailer-email-button");var n=$(".ui-pgrid-toolbar-container").closest("div.ui-pgrid");var r=n.find(".ui-pgrid-table");var i="";var s=e.find(".mailer-email-modal-container").find(".modal");var o=e.find(".mailer-template-select");var u=e.find(".mailer-template-description");var a=e.find(".mailer-custom-message");var f=s.attr("data-url");var l=s.find(".send-email-btn");var c=s.find(".before-send");var h=s.find(".sending-sent");var p=s.find(".send-status");var d=s.find(".email-prefix-edit");var v=s.find(".email-prefix-label");var m=s.find(".email-prefix");var g=s.find("[name=sender]");var y=s.find(".email-suffix").text();var b=s.find(".email-container");var w=s.find(".cancel-btn");var E=s.find(".done-btn");var S=s.find(".results-container");var x=s.find(".progress-container .progress");var T=s.find(".partial-sent");var N=s.find(".full-sent");var C=s.find(".full-failed");var k=s.find(".partial-sent-num");var L=s.find(".partial-skipped-num");var A=s.find(".partial-failed-num");var O=s.find(".partial-result-item");if(r.find("td").length){i=M()}n.bind("rows_added.pgrid",function(){if(i!="")return;i=M()});window.mailer_send_email_modal=function(){var e=r.pgrid_get_selected_rows();var t=e.length;if(t<1){alert("Please make a selection before performing this operation.");return}var n=[];e.each(function(){var e=$(this).attr("title");n.push(parseInt(e))});n=JSON.stringify(n);c.show();s.find(".num-rows").text(t);s.find("[name=guids]").val(n);s.find("[name=entity_class]").val(i);o.val("").change();if(t<2){a.show();s.find("[name=custom_message]").val("")}else{a.hide();s.find("[name=custom_message]").val("")}S.hide();T.add(C).add(N).hide();h.text("Sending");l.html('<i class="icon-envelope"></i> Send Email');p.html("");w.show();E.removeClass("btn-success").addClass("btn-info");s.find("option."+i).hide();s.modal()};t.find(".add-item").each(function(){r.pgrid_add_toolbar_item($(this))});o.change(function(){var e=o.val();var t=o.find("option[value="+e+"]").attr("data-description");u.text(t);if(e!="")l.addClass("btn-success").removeClass("btn-info");else l.addClass("btn-info").removeClass("btn-success")}).change();l.click(function(){if(!l.hasClass("btn-success")){p.html('<i class="icon-info-sign"></i> Please choose a template!');return}P()});d.add(b).click(function(){if(!b.find("i").length)return;if(v.is(":visible")){v.hide();m.fadeIn().select()}});m.focusout(function(){m.hide();var e=m.val();g.val(e+y);v.text(e).fadeIn()})};n()});