/*
 * Pines Framework Testimonials JavaScript
 *
 * http://pinesframework.org/
 * Copyright (c) 2013 SciActive
 * Author: Angela Murrell <angela@sciactive.com>
 *
 * Triple license under the GPL, LGPL, and MPL:
 *	  http://www.gnu.org/licenses/gpl.html
 *	  http://www.gnu.org/licenses/lgpl.html
 *	  http://www.mozilla.org/MPL/MPL-1.1.html
 */
pines(function(){var e=function(e){var t=e.find(".testimonials-module"),n=t.find(".give-feedback"),r=n.find(".trigger-feedback"),i=t.find("#feedback_form"),s=i.find('[name="anon"]'),o=i.find('[name="share"]'),u=t.find(".submit-button"),a=t.find("[name=feedback]"),f=t.find(".share-again"),l=t.find(".form-submit"),c=t.find(".form-content"),h=l.find(".please-rate-us"),p=l.find(".feedback-status-icon"),d=l.find(".feedback-status-words"),v=c.find(".star"),m=h.find(".star"),g=c.find(".rating-container"),y=c.find(".star-container"),b=t.find(".average-rating"),w=b.find(".star-rating"),E=b.find(".votes"),S=t.find(".testimonials"),x=t.find(".login-container"),T=x.find(".signup-button");var N=t.find(".testimonial-loader"),C=t.find(".loaded-testimonial"),k=e,L=t.find(".average-rating"),A=t.find(".no-average-rating"),O=t.find(".story"),M=t.find(".testimonial-list-container"),_=t.find(".list-read-more"),D=t.find(".list-up"),P=t.find(".list-top");if(!k.length){console.log("Please wrap your testimonial module in an element with a class testimonial-box. Put all your options in inputs within that same box.");return}var H=function(e){return e==undefined?"":e.val()};var B=k.find("[name=review_option_reverse]"),j=k.find("[name=review_option_limit]"),F=k.find("[name=review_option_offset]"),I=k.find("[name=review_option_type]"),q=k.find("[name=review_data_type]"),R=k.find("[name=review_option_display]"),U=k.find("[name=review_option_additional_tags]"),z=k.find("[name=review_option_clear]"),W=k.find("[name=review_option_feedback_text]"),X=k.find("[name=review_option_story_text]"),V=k.find("[name=review_item_name]"),J=k.find("[name=review_list_height]"),K=k.find("[name=review_option_dates]"),Q=k.find("[name=review_ratings_off]"),G=k.find("[name=review_submit_refresh]"),Y=k.find("[name=review_module_hidden]"),Z=k.find("[name=review_option_quotes]"),et=k.find("[name=review_signup_url]");if(I.val()=="review"){var tt=k.find("[name=review_option_entity]");var nt=k.find("[name=review_option_entity_id]");var rt=k.find("[name=review_option_name]")}if(!logged_in){var it=x.find(".pf-element").first();if(it.find("label").text()==" I have an account.")it.hide();setTimeout(function(){x.find(".btn-primary").prop("value","Sign In")},300);if(H(et)!="")T.attr("href",et.val())}$(window).resize(function(){if(t.width()<600)t.addClass("small");else t.removeClass("small")}).resize();r.click(function(){if(n.hasClass("opened")){n.removeClass("opened");i.fadeOut(50)}else{n.addClass("opened");i.fadeIn(1e3)}});o.change(function(){if($(this).is(":checked")){s.removeAttr("disabled").closest("label").show()}else s.attr("disabled","disabled").closest("label").hide()});f.click(function(){p.addClass("icon-spin icon-spinner").removeClass("icon-ok");d.text("Submitting");f.css("visiblity","hidden");if(d.text()!="Error. Not Submitted.")a.val("");l.hide();c.fadeIn();c.css("height","auto")});m.click(function(){var e=$(this);var t=e.prevAll(".star").length;v.eq(t).click();p.show();u.click()});v.click(function(){var e=$(this);var t=e.nextAll(".star").andSelf();var n=t.length;v.removeClass("rated");t.addClass("rated");v.hide();if(n>3)y.append('<span class="remove"><i class="icon-ok"></i> <span>Thanks!</span></span></span>').fadeIn(200);else y.append('<span class="remove" style="font-size: 14px;"><i class="icon-ok"></i></span>').fadeIn(200);setTimeout(function(){y.find(".remove").remove();v.fadeIn()},700)});if(logged_in&&customer){u.click(function(e){e.preventDefault();h.hide();var t=i.height()-11;l.height(t);if(H(a)!=""&&(c.find(".rated").length||H(Q)=="true")){var n=a.val(),r=o.is(":checked")?"ON":"",u=s.is(":checked")?"ON":"",v=c.find(".rated").length;c.hide();l.fadeIn();var m={};m.type="module";m.customer=customer_guid;m.feedback=n;m.share=r;m.anon=u;m.rating=v;m.review_option_entity=H(tt);m.review_option_entity_id=H(nt);m.review_option_additional_tags=H(U);m.review_option_name=H(rt);m.review_option_type=H(I);m.review_data_type=H(q);$.ajax({url:save_testimonial_url,type:"POST",dataType:"json",data:m,beforeSend:function(){p.addClass("icon-spin icon-spinner").removeClass("icon-ok");d.text("Submitting");f.css("visibility","hidden")},error:function(e,t){pines.error("An error occured:\n"+pines.safe(e.status)+": "+pines.safe(t));p.removeClass("icon-spin icon-spinner").removeClass("icon-remove");d.text("Error. Not Submitted.");f.hide().text("Try Again?").css("visibility","visible").fadeIn()},success:function(e){if(!e){p.removeClass("icon-spin icon-spinner icon-warning-sign icon-ok").addClass("icon-remove");d.text("Error. Not Submitted.");f.hide().text("Try Again?").css("visibility","visible").fadeIn();return false}if(e){p.removeClass("icon-spin icon-spinner icon-warning icon-remove").addClass("icon-ok");d.text("Success!");if(H(X)!="")var t=X.val();else var t="Story";f.hide().text("Share another "+t+"?").css("visibility","visible").fadeIn();if(H(G)=="true"&&H(R)=="list"){var n=M.height();M.animate({scrollTop:n},function(){_.click()})}return false}if(!e.result){p.removeClass("icon-spin icon-spinner icon-ok icon-warning-sign").addClass("icon-remove");d.text(e.message);f.hide().text("Try Again?").css("visibility","visible").fadeIn();return false}}})}else if(a.val()!=""&&H(Q)!="true"){p.hide();h.show();d.text("Please Rate Us!");c.hide();f.css("visibility","hidden");l.fadeIn()}else{p.removeClass("icon-spin icon-spinner icon-remove").addClass("icon-warning-sign");d.text("Incomplete!");f.css("visibility","hidden");setTimeout(function(){c.hide()},20);l.fadeIn();setTimeout(function(){p.addClass("icon-spin icon-spinner").removeClass("icon-ok icon-warning-sign icon-remove");d.text("Submitting");f.css("visibility","hidden");setTimeout(function(){l.hide()},20);c.fadeIn();i.css("height","auto")},500)}return false})}if(H(R)=="carousel"){var st=function(e){var t=e.length,n,r;while(0!==t){r=Math.floor(Math.random()*t);t-=1;n=e[t];e[t]=e[r];e[r]=n}return e}}var ot=function(){if(H(W)!=""){r.text(W.val())}if(H(X)!=""){O.text(X.val())}if(H(z)=="true"){C.hide();L.hide();if(H(V)!="")A.text(pines.safe(V.val()));A.show();k.hide();k.css("visibility","visible");k.fadeIn();N.fadeIn()}var e={};e.review_reverse=H(B);e.review_limit=H(j);e.review_offset=H(F);e.review_tags=H(U);e.review_entity=H(tt);e.review_entity_id=H(nt);e.review_name=H(rt);e.review_option_type=H(I);e.review_data_type=H(q);e.review_ratings_off=H(Q);if(H(Q)=="true"){g.remove()}if(H(R)=="list"){ut(e);return}if(H(R)=="carousel")at(e,"carousel")};var ut=function(e){S.addClass("make-list");if(H(J)!=""){S.css("height",J.val()+"px")}if(!t.hasClass("list-started")){t.addClass("list-started");var n=H(J)!=""?parseInt(J.val())-40:120;_.click(function(){if(M[0].scrollHeight-M.scrollTop()==M.height()){ut(e)}var t=M.scrollTop()+n;M.animate({scrollTop:t})});M.scroll(function(){if(M[0].scrollHeight-M.scrollTop()==M.height()){ut(e)}});D.click(function(){var e=M.scrollTop()-n;M.animate({scrollTop:e})});P.click(function(){M.animate({scrollTop:0})})}e.review_offset=H(F);at(e,"list")};var at=function(e,t){$.ajax({url:get_testimonials_url,type:"POST",dataType:"json",data:e,beforeSend:function(){if(t=="list"){_.css("visibility","hidden");_.find("i").remove();_.prepend('<i class="icon-spin icon-spinner"></i> ');_.hide().css("visibility","visible").fadeIn()}},error:function(e,n){pines.error("An error occured:\n"+pines.safe(e.status)+": "+pines.safe(n));if(t=="list"){_.find("i").remove();_.text("Error Loading...");_.prepend('<i class="icon-remove"></i> ')}if(H(z)=="true"){N.text("An Error Occurred.");N.find("i").removeAttr("class").addClass("icon-remove")}},success:function(e){if(e=="No testimonials found."){var n=M.find(".testimonial.item").length;F.val(n);if(N.is(":visible")){N.text("Be the First to Share!");N.find("i").removeAttr("class").addClass("icon-thumbs-up");_.find("i").remove();_.text("Share yours!");_.prepend('<i class="icon-edit"></i> ');_.css("visibility","hidden");_.hide().css("visibility","visible").fadeIn();return}else{_.find("i").remove();_.text("No More Reviews. Share yours!");_.prepend('<i class="icon-edit"></i> ');_.css("visibility","hidden");_.hide().css("visibility","visible").fadeIn();return}}N.hide();if(t=="list"){_.find("i").remove();_.css("visibility","hidden");_.hide().css("visibility","visible").fadeIn()}else{M.find(".list-placeholder").remove();_.hide()}M.fadeIn();lt(e,t)}})};var ft=function(e){var t=$("<blockquote></blockquote>");t.append('<meta content="'+H(V)+'" itemprop="about"/>');t.append('<meta content="'+H(V)+'" itemprop="name"/>');if(H(Z)=="false")t.append('<p class="description" itemprop="description">'+e.testimonial+"</p>");else t.append('<p class="description" itemprop="description">"'+e.testimonial+'"</p>');if(e.author!=false){var n=e.author.replace(/ in.*$/,"");var r=" in"+e.author.replace(/.*?in/,"");if(show_entity_help)t.append('<small><a data-entity="'+e.guid+'" data-entity-context="com_testimonials_testimonial"><span itemprop="author">'+n+"</span></a>"+r+"</small>");else t.append('<small><span itemprop="author">'+n+"</span>"+r+"</small>")}else{if(viewanonauthor)t.append('<small>Posted Anonymously by <a data-entity="'+e.guid+'" data-entity-context="com_testimonials_testimonial"><span itemprop="author">'+e.customer_name+"</span></a></small>")}if(H(Q)!="true"){var i=$('<div class="pull-right rating-container"><span itemprop="reviewRating" itemscope itemtype="http://schema.org/Rating"><meta itemprop="worstRating" content="1"><meta itemprop="bestRating" content="5"><meta itemprop="ratingValue" content="'+e.rating+'"></span></div>');for(var s=1;s<=5;s++){if(e.rating>=s){i.find("span").append('<i class="icon-star"></i> ')}else{i.find("span").append('<i class="icon-star-empty"></i> ')}}t.append(i)}if(H(K)!=""){if(K.val()=="true"){var o=$('<div style="clear:both" class="pull-right"></div>');o.append('<abbr itemprop="datePublished" class="timeago" title="'+e.timeago+'">'+e.date+"</abbr>");t.append(o)}else{t.append('<meta content="'+e.date+'" itemprop="datePublished"/>')}}var u=$('<div class="testimonial item hide" itemtype="http://schema.org/Review" itemscope="" itemprop="review"><div class="content clearfix"></div><div class="item-bottom-border"></div></div>');u.find(".content").append(t);u.find(".timeago").timeago();return u};var lt=function(e,n){if(n=="list"){$.each(e,function(e,t){var n=ft(t);M.find(".list-placeholder").before(n);n.fadeIn()})}else{e=st(e);S.addClass("carousel slide");M.addClass("carousel-inner");var r=-1;$.each(e,function(e,t){var n=ft(t);M.append(n);if(H(Y)=="true"){var i=n.clone().addClass("remove-temp-item");$("body").append(i);i.css({visibility:"hidden",position:"absolute",display:"block"});var s=i.height();r=s>r?s:r;n.find(".item-bottom-border").remove()}else{n.css("visibility","hidden");var s=n.height();r=s>r?s:r;n.find(".item-bottom-border").remove()}});if(H(Y)=="true"){$(".remove-temp-item").remove()}S.height(r);C.hide();M.find(".item").each(function(){var e=$(this);e.css({visibility:"visible","margin-top":(r-e.height())/2+"px"})}).first().addClass("active")}if(!t.hasClass("initialized")){if(n=="carousel"){S.carousel({pause:"hover",interval:6e3})}t.addClass("initialized")}var i=M.find(".testimonial.item").length;F.val(i)};ot();if(w.length){w.tooltip()}};$(".testimonial-box").each(function(){if(!$(this).hasClass("manual-trigger")&&!$(this).closest(".manual-trigger").length)e($(this))});window.create_testimonial_module=e})