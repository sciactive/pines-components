/*
 * Pines Framework Testimonials JavaScript
 *
 * http://pinesframework.org/
 * Copyright (c) 2013 SciActive
 * Author: Angela Murrell <angela@sciactive.com>
 *
 * Triple license under the GPL, LGPL, and MPL:
 *	  http://www.gnu.org/licenses/gpl.html
 *	  http://www.gnu.org/licenses/lgpl.html
 *	  http://www.mozilla.org/MPL/MPL-1.1.html
 */
pines(function(){var e=function(e){var t=e.find(".testimonials-module"),n=t.find(".give-feedback"),r=n.find(".trigger-feedback"),i=t.find("#feedback_form"),s=i.find('[name="anon"]'),o=i.find('[name="share"]'),u=t.find(".submit-button"),a=t.find("[name=feedback]"),f=t.find(".share-again"),l=t.find(".form-submit"),c=t.find(".form-content"),h=l.find(".please-rate-us"),p=l.find(".feedback-status-icon"),d=l.find(".feedback-status-words"),v=c.find(".star"),m=h.find(".star"),g=c.find(".rating-container"),y=c.find(".star-container"),b=t.find(".average-rating"),w=b.find(".star-rating"),E=b.find(".votes"),S=t.find(".testimonials"),x=t.find(".login-container"),T=x.find(".signup-button");var N=t.find(".testimonial-info"),C=N.find(".test-info-save-testimonial-url").text(),k=N.find(".test-info-get-testimonial-url").text(),L=N.find(".test-info-save-testimonial-url").text()=="true"?true:false,A=N.find(".test-info-save-testimonial-url").text()=="true"?true:false,O=N.find(".test-info-save-testimonial-url").text()=="true"?true:false,M=N.find(".test-info-save-testimonial-url").text()=="true"?true:false,_=N.find(".test-info-save-testimonial-url").text(),D=_!=""?parseInt(_):0;N.remove();var P=t.find(".testimonial-loader"),H=t.find(".loaded-testimonial"),B=e,j=t.find(".average-rating"),F=t.find(".no-average-rating"),I=t.find(".story"),q=t.find(".testimonial-list-container"),R=t.find(".list-read-more"),U=t.find(".list-up"),z=t.find(".list-top");if(!B.length){console.log("Please wrap your testimonial module in an element with a class testimonial-box. Put all your options in inputs within that same box.");return}var W=function(e){return e==undefined?"":e.val()};var X=B.find("[name=review_option_reverse]"),V=B.find("[name=review_option_limit]"),J=B.find("[name=review_option_offset]"),K=B.find("[name=review_option_type]"),Q=B.find("[name=review_data_type]"),G=B.find("[name=review_option_display]"),Y=B.find("[name=review_option_additional_tags]"),Z=B.find("[name=review_option_clear]"),et=B.find("[name=review_option_feedback_text]"),tt=B.find("[name=review_option_story_text]"),nt=B.find("[name=review_item_name]"),rt=B.find("[name=review_list_height]"),it=B.find("[name=review_option_dates]"),st=B.find("[name=review_ratings_off]"),ot=B.find("[name=review_submit_refresh]"),ut=B.find("[name=review_module_hidden]"),at=B.find("[name=review_option_quotes]"),ft=B.find("[name=review_signup_url]");if(K.val()=="review"){var lt=B.find("[name=review_option_entity]");var ct=B.find("[name=review_option_entity_id]");var ht=B.find("[name=review_option_name]")}if(!O){var pt=x.find(".pf-element").first();if(pt.find("label").text()==" I have an account.")pt.hide();setTimeout(function(){x.find(".btn-primary").prop("value","Sign In")},300);if(W(ft)!="")T.attr("href",ft.val())}$(window).resize(function(){if(t.width()<600)t.addClass("small");else t.removeClass("small")}).resize();r.click(function(){if(n.hasClass("opened")){n.removeClass("opened");i.fadeOut(50)}else{n.addClass("opened");i.fadeIn(1e3)}});o.change(function(){if($(this).is(":checked")){s.removeAttr("disabled").closest("label").show()}else s.attr("disabled","disabled").closest("label").hide()});f.click(function(){p.addClass("icon-spin icon-spinner").removeClass("icon-ok");d.text("Submitting");f.css("visiblity","hidden");if(d.text()!="Error. Not Submitted.")a.val("");l.hide();c.fadeIn();c.css("height","auto")});m.click(function(){var e=$(this);var t=e.prevAll(".star").length;v.eq(t).click();p.show();u.click()});v.click(function(){var e=$(this);var t=e.nextAll(".star").andSelf();var n=t.length;v.removeClass("rated");t.addClass("rated");v.hide();if(n>3)y.append('<span class="remove"><i class="icon-ok"></i> <span>Thanks!</span></span></span>').fadeIn(200);else y.append('<span class="remove" style="font-size: 14px;"><i class="icon-ok"></i></span>').fadeIn(200);setTimeout(function(){y.find(".remove").remove();v.fadeIn()},700)});if(O&&M){u.click(function(e){e.preventDefault();h.hide();var t=i.height()-11;l.height(t);if(W(a)!=""&&(c.find(".rated").length||W(st)=="true")){var n=a.val(),r=o.is(":checked")?"ON":"",u=s.is(":checked")?"ON":"",v=c.find(".rated").length;c.hide();l.fadeIn();var m={};m.type="module";m.customer=D;m.feedback=n;m.share=r;m.anon=u;m.rating=v;m.review_option_entity=W(lt);m.review_option_entity_id=W(ct);m.review_option_additional_tags=W(Y);m.review_option_name=W(ht);m.review_option_type=W(K);m.review_data_type=W(Q);$.ajax({url:C,type:"POST",dataType:"json",data:m,beforeSend:function(){p.addClass("icon-spin icon-spinner").removeClass("icon-ok");d.text("Submitting");f.css("visibility","hidden")},error:function(e,t){pines.error("An error occured:\n"+pines.safe(e.status)+": "+pines.safe(t));p.removeClass("icon-spin icon-spinner").removeClass("icon-remove");d.text("Error. Not Submitted.");f.hide().text("Try Again?").css("visibility","visible").fadeIn()},success:function(e){if(!e){p.removeClass("icon-spin icon-spinner icon-warning-sign icon-ok").addClass("icon-remove");d.text("Error. Not Submitted.");f.hide().text("Try Again?").css("visibility","visible").fadeIn();return false}if(e){p.removeClass("icon-spin icon-spinner icon-warning icon-remove").addClass("icon-ok");d.text("Success!");if(W(tt)!="")var t=tt.val();else var t="Story";f.hide().text("Share another "+t+"?").css("visibility","visible").fadeIn();if(W(ot)=="true"&&W(G)=="list"){var n=q.height();q.animate({scrollTop:n},function(){R.click()})}return false}if(!e.result){p.removeClass("icon-spin icon-spinner icon-ok icon-warning-sign").addClass("icon-remove");d.text(e.message);f.hide().text("Try Again?").css("visibility","visible").fadeIn();return false}}})}else if(a.val()!=""&&W(st)!="true"){p.hide();h.show();d.text("Please Rate Us!");c.hide();f.css("visibility","hidden");l.fadeIn()}else{p.removeClass("icon-spin icon-spinner icon-remove").addClass("icon-warning-sign");d.text("Incomplete!");f.css("visibility","hidden");setTimeout(function(){c.hide()},20);l.fadeIn();setTimeout(function(){p.addClass("icon-spin icon-spinner").removeClass("icon-ok icon-warning-sign icon-remove");d.text("Submitting");f.css("visibility","hidden");setTimeout(function(){l.hide()},20);c.fadeIn();i.css("height","auto")},500)}return false})}if(W(G)=="carousel"){var dt=function(e){var t=e.length,n,r;while(0!==t){r=Math.floor(Math.random()*t);t-=1;n=e[t];e[t]=e[r];e[r]=n}return e}}var vt=function(){if(W(et)!=""){r.text(et.val())}if(W(tt)!=""){I.text(tt.val())}if(W(Z)=="true"){H.hide();j.hide();if(W(nt)!="")F.text(pines.safe(nt.val()));F.show();B.hide();B.css("visibility","visible");B.fadeIn();P.fadeIn()}var e={};e.review_reverse=W(X);e.review_limit=W(V);e.review_offset=W(J);e.review_tags=W(Y);e.review_entity=W(lt);e.review_entity_id=W(ct);e.review_name=W(ht);e.review_option_type=W(K);e.review_data_type=W(Q);e.review_ratings_off=W(st);if(W(st)=="true"){g.remove()}if(W(G)=="list"){mt(e);return}if(W(G)=="carousel")gt(e,"carousel")};var mt=function(e){S.addClass("make-list");if(W(rt)!=""){S.css("height",rt.val()+"px")}if(!t.hasClass("list-started")){t.addClass("list-started");var n=W(rt)!=""?parseInt(rt.val())-40:120;R.click(function(){if(q[0].scrollHeight-q.scrollTop()==q.height()){mt(e)}var t=q.scrollTop()+n;q.animate({scrollTop:t})});q.scroll(function(){if(q[0].scrollHeight-q.scrollTop()==q.height()){mt(e)}});U.click(function(){var e=q.scrollTop()-n;q.animate({scrollTop:e})});z.click(function(){q.animate({scrollTop:0})})}e.review_offset=W(J);gt(e,"list")};var gt=function(e,t){$.ajax({url:k,type:"POST",dataType:"json",data:e,beforeSend:function(){if(t=="list"){R.css("visibility","hidden");R.find("i").remove();R.prepend('<i class="icon-spin icon-spinner"></i> ');R.hide().css("visibility","visible").fadeIn()}},error:function(e,n){pines.error("An error occured:\n"+pines.safe(e.status)+": "+pines.safe(n));if(t=="list"){R.find("i").remove();R.text("Error Loading...");R.prepend('<i class="icon-remove"></i> ')}if(W(Z)=="true"){P.text("An Error Occurred.");P.find("i").removeAttr("class").addClass("icon-remove")}},success:function(e){if(e=="No testimonials found."){var n=q.find(".testimonial.item").length;J.val(n);if(P.is(":visible")){P.text("Be the First to Share!");P.find("i").removeAttr("class").addClass("icon-thumbs-up");R.find("i").remove();R.text("Share yours!");R.prepend('<i class="icon-edit"></i> ');R.css("visibility","hidden");R.hide().css("visibility","visible").fadeIn();return}else{R.find("i").remove();R.text("No More Reviews. Share yours!");R.prepend('<i class="icon-edit"></i> ');R.css("visibility","hidden");R.hide().css("visibility","visible").fadeIn();return}}P.hide();if(t=="list"){R.find("i").remove();R.css("visibility","hidden");R.hide().css("visibility","visible").fadeIn()}else{q.find(".list-placeholder").remove();R.hide()}q.fadeIn();bt(e,t)}})};var yt=function(e){var t=$("<blockquote></blockquote>");t.append('<meta content="'+W(nt)+'" itemprop="about"/>');t.append('<meta content="'+W(nt)+'" itemprop="name"/>');if(W(at)=="false")t.append('<p class="description" itemprop="description">'+e.testimonial+"</p>");else t.append('<p class="description" itemprop="description">"'+e.testimonial+'"</p>');if(e.author!=false){var n=e.author.replace(/ in.*$/,"");var r=" in"+e.author.replace(/.*?in/,"");if(L)t.append('<small><a data-entity="'+e.guid+'" data-entity-context="com_testimonials_testimonial"><span itemprop="author">'+n+"</span></a>"+r+"</small>");else t.append('<small><span itemprop="author">'+n+"</span>"+r+"</small>")}else{if(A)t.append('<small>Posted Anonymously by <a data-entity="'+e.guid+'" data-entity-context="com_testimonials_testimonial"><span itemprop="author">'+e.customer_name+"</span></a></small>")}if(W(st)!="true"){var i=$('<div class="pull-right rating-container"><span itemprop="reviewRating" itemscope itemtype="http://schema.org/Rating"><meta itemprop="worstRating" content="1"><meta itemprop="bestRating" content="5"><meta itemprop="ratingValue" content="'+e.rating+'"></span></div>');for(var s=1;s<=5;s++){if(e.rating>=s){i.find("span").append('<i class="icon-star"></i> ')}else{i.find("span").append('<i class="icon-star-empty"></i> ')}}t.append(i)}if(W(it)!=""){if(it.val()=="true"){var o=$('<div style="clear:both" class="pull-right"></div>');o.append('<abbr itemprop="datePublished" class="timeago" title="'+e.timeago+'">'+e.date+"</abbr>");t.append(o)}else{t.append('<meta content="'+e.date+'" itemprop="datePublished"/>')}}var u=$('<div class="testimonial item hide" itemtype="http://schema.org/Review" itemscope="" itemprop="review"><div class="content clearfix"></div><div class="item-bottom-border"></div></div>');u.find(".content").append(t);u.find(".timeago").timeago();return u};var bt=function(e,n){if(n=="list"){$.each(e,function(e,t){var n=yt(t);q.find(".list-placeholder").before(n);n.fadeIn()})}else{e=dt(e);S.addClass("carousel slide");q.addClass("carousel-inner");var r=-1;$.each(e,function(e,t){var n=yt(t);q.append(n);if(W(ut)=="true"){var i=n.clone().addClass("remove-temp-item");$("body").append(i);i.css({visibility:"hidden",position:"absolute",display:"block"});var s=i.height();r=s>r?s:r;n.find(".item-bottom-border").remove()}else{n.css("visibility","hidden");var s=n.height();r=s>r?s:r;n.find(".item-bottom-border").remove()}});if(W(ut)=="true"){$(".remove-temp-item").remove()}S.height(r);H.hide();q.find(".item").each(function(){var e=$(this);e.css({visibility:"visible","margin-top":(r-e.height())/2+"px"})}).first().addClass("active")}if(!t.hasClass("initialized")){if(n=="carousel"){S.carousel({pause:"hover",interval:6e3})}t.addClass("initialized")}var i=q.find(".testimonial.item").length;J.val(i)};vt();if(w.length){w.tooltip()}};$(".testimonial-box").each(function(){if(!$(this).hasClass("manual-trigger")&&!$(this).closest(".manual-trigger").length)e($(this))});window.create_testimonial_module=e});